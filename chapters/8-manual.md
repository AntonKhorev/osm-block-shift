---
title: Сдвиг вручную
---

Теперь, когда нужные данные выделены, их можно сдвинуть. В самом простом случае тут особо не о чем говорить. Достаточно перейти в режим выбора, который служит также режимом сдвига, и перетащить выделенное на нужное место. Нужное место можно определить по подложке спутникового снимка с желаемым смещением. Если мы смогли это сделать с удовлетворяющей нас точностью, то дело почти сделано. Остаётся только поправить линии, пересекающие границу выделения, о чём написано в [последующей главе](../11-cleanup/). Но, возможно, сделать мы этого не смогли. Вот возможные причины этого:

* после перемещения здания перекрывают собой то, что находится рядом с ними;
* отдельные здания смещены относительно других зданий;
* весь квартал имеет неправильный размер;
* весь квартал имеет неправильную форму;
* точность перемещения вручную недостаточна.

Эти причины могут обнаружиться в любых комбинациях, хоть все сразу. Рассмотрим по очереди, откуда они берутся, и что с ними делать.

## Перекрытия с объектами

Допустим, что здания после перемещения пересеклись с чем-то ещё, с чем они пересекаться не должны. С чем именно они могут пересечься? Чаще всего это тротуар вокруг квартала или точечный объект типа остановки общественного транспорта. В особо тяжёлом случае это может быть линия самой улицы. Если дело может дойти до такого, то возможны и промежуточные варианты, когда здания пересекаются с газонами и прочими объектами между тротуаром и проезжей частью. Впрочем, если имеет место тяжёлый случай, то такие объекты это обычно ещё не нарисованы. Да и сам случай существенного пересечения зданий с тем, что предшественники считали площадью улицы, будет более вероятен для узких улиц, где всего этого нет.

На потенциальные пересечения зданий с прочими объектами мы должны были обратить внимание ещё до сдвига, когда мы выбирали, собственно какие объекты следует двигать. Если после сдвига случилось пересечение, то, возможно, выбор мы осуществили неправильно, и ситуацию можно исправить так: отменить сдвиг, добавить к выборке объекты, с которыми произошло пересечение и выполнить сдвиг снова. Легче всего так поступить с точечными объектами. Если нам не кажется, что точечные объекты были поставлены с существенной точностью, мы можем поступить и ещё проще: сдвинуть их отдельно, не отменяя сдвиг всего квартала.

Вообще, в данной записи мы не оправдываем свои неаккуратные действия тем, что данные и так были корявые, а сдвиг мешающих объектов отдельно - как раз такое действие. Тем не менее, иногда действительно ясно, что будь объект сдвинут вместе с кварталом, он оказался бы совсем не там, где надо. Например, это может быть урна, стоящая на тротуаре, которая попала бы глубоко на проезжую часть. Тогда нам всё равно пришлось бы двигать такой объект вручную, а, значит, можно это сделать и без отмены сдвига квартала.

Иногда на ручной сдвиг оказывающегося явно не там объекта можно возразить, что объект лишь отчасти был поставлен относительно зданий, а именно по направлению вдоль улицы. По направлению поперёк его пришлось ставить уже относительно дороги. Такое вполне возможно, например, для тех остановок транспорта, которых не видно на спутниковых снимках, и которые пришлось ставить относительно зданий, но также и на определённом расстоянии от дороги. Тогда более правильно было бы двигать объект вместе с кварталом, а потом поправлять вручную только положение по направлению поперёк. К счастью, у нас обычно имеется достаточно возможностей перепроверить положение объекта по панорамам улиц или другим подобным снимкам, что даёт возможность просто сдвинуть его отдельно и при этом ничего не испортить. Чтобы застраховаться от устаревших снимков, можно проверить историю редактирования объекта и узнать, был ли они введен и поставлен на определённое место раньше снимков. Если да, можно смело переставлять его согласно этим снимкам.

Если пересечение произошло с линейным объектом типа тротуара, то, при одном из вариантов действий, мы могли специально оставить его на месте перед сдвигом, чтобы поправить его потом. Если так, то нам и остаётся его поправить, что после сдвига квартала может быть сделать легче, чем до, так как мы уже определились с конечным положением зданий. В принципе, логично предположить, что тротуар следует рисовать относительно зданий, так как он близко к ним расположен, и должен быть на определённом от них расстоянии. Однако, как выяснится из способа *перерисовки осей*, которым я пугаю читателей на протяжении всей [главы про определение области сдвига](../5-area/), это не совсем так, и дело даже, в некотором роде, обстоит наоборот. Но, если мы на этот способ не решимся, нарисовать линию тротуара относительно зданий вполне логично. Вообще тротуар из-за своего близкого к зданиям положения и является наиболее вероятным объектом, мешающим сдвигу. Если расстояние между ним и зданиями было небольшое ещё до сдвига, то его стоило двигать вместе со зданиями. Если в этом случае мы его не сдвинули, значит мы ошиблись с выбором сдвигаемых объектов.

Так просто, подвинув вместе со зданиями или отдельно вручную мешающий объект, нам поступить не удастся в особо тяжёлом случае пересечения с линией улицы. Случай окажется тяжёлым также, если улица хоть и не пересекается со зданиями, но оказывается к ним неестественно близко. Между ней и зданиями надо вместить тротуар и всё, что на нём находится, что в последнем случае будет сделать проблематично, да и в принципе положение линии в упор к зданиям на одной стороне и далеко от зданий на другой выглядит странно. Понятно, что линию улицы следует подвинуть.

Если двигать линию улицы, а точнее её точки на участке у квартала, вместе с самим кварталом, результат вряд ли получится удовлетворительным. Любой сдвиг по направлению вдоль улицы изогнёт участки пересекающих её улиц. При сдвиге же поперёк она сама изогнётся на перекрёстках. Проще перерисовать весь её прямой участок независимо от того, как сдвигается квартал. Это и будет началом способа *перерисовки осей*, но мы можем решить до конца его не доводить. Если линия улицы, согласно нашим соображениям, была в достаточной степени не на своём месте, можно ограничиться перерисовкой одного лишь её участка, что можно сделать как до, так и после сдвига квартала. При полном использовании способа это пришлось бы делать именно до сдвига. Значит, если мы на это решимся, выполненный сдвиг надо отменить, после чего переходить к упоминаемому способу.

Проблем с тем, что мы не рассчитали до сдвига, что под него попадёт, можно избежать, воспользовавшись вместо сдвига вручную описываемым ниже способом *сдвига по направляющим*. При нём мы нарисуем контур квартала на желаемом месте, после чего будет понятно, что именно внутрь контура попадает. Более серьёзные причины для применения этого способа также описываются ниже.

## Смещения отдельных зданий

Описываемые выше ситуации предполагали, что мы можем определиться с конечным положением сдвига, то есть отпустить кнопку мыши так, чтобы перетаскиваемые здания встали на нужные места. Сделать это мы пытаемся, совмещая здания с заранее установленным снимком. При этом может получиться так, что, ставя одно здание на своё место, мы сдвигаем с правильного места другое. Поскольку все здания мы перемещаем одновременно, нам придётся выбирать, какое из зданий оставить не на своём месте, возможно, оба.

Здесь мы сталкиваемся с ситуацией, когда здания смещены относительно других зданий, и, возможно, они также имеют неправильные размеры. Причиной этого может быть неправильный размер или форма всего квартала, но к этому случаю мы перейдём позже. Сейчас мы предположим, что контур квартала примерно правильный, или таковым мы его уже сделали. Внутри же квартала здания всё равно сдвинуты друг относительно друга. Наиболее вероятной причиной этого является рисование зданий по снимкам, сделанным под углом, когда участники ориентируются по крышам, изображения которых смещены относительно уровня земли.

Ясно, что в такой ситуации для исправления зданий одного лишь сдвига их всех вместе будет недостаточно, и потребуется редактирование отдельно взятых зданий и того, что рядом с ними находится. Однако до этого нам лучше сделать сдвиг квартала, то есть всё-таки определиться с его конечным положением. Так как контур всего квартала примерно соответствует действительности, то его и стоит совмещать со снимком. То есть, мы будем смотреть не на отдельные здания, а на весь квартал целиком, так чтобы после его совместного сдвига последующие поправки состояли из сдвигов отдельных элементов на как можно меньшие расстояния.

Если мы ещё не решились рисовать направляющие вокруг квартала, то прицеливаться нам удобнее по угловым зданиям. Если квартал четырёхугольный, то мы сначала попытаемся наилучшим образом совместить со снимком его четыре угла, после чего перейдём к корректировке геометрии зданий. Если все углы удалось совместить достаточно хорошо, и внутренности квартала нас не интересуют, мы можем дальнейшей корректировкой не заниматься. Наша главная задача при сдвиге, как и ранее - не испортить данные, а испортить легче всего то, о чём мы не знаем, и что нас не интересует.

Сами здания на снимках обычно видны достаточно хорошо, и даже если снимки сделаны под такими углами, которые и привели к искажениям в осмовских данных, мы можем проявить большую аккуратность и поправить форму зданий. Что мы обычно не можем сделать - это поправить форму того, чего на снимках не видно и мы самостоятельно не проверяли. Если кто-то до нас мапил внутренности квартала, он рисовал невидимые для нас вещи относительно зданий, сколь бы криво здания не были обозначены. При исправлении зданий нам придётся заняться и исправлением этих вещей, что может оказаться невозможным. Именно поэтому мы делаем в первую очередь сдвиг всего квартала: при самом сдвиге мы не внесём искажений в неизвестные нам данные, а последующие исправления мы делаем так, чтобы искажения минимизировать. Не делать сдвиг квартала мы могли бы себе позволить, если бы у нас был снимок, на котором хорошо было бы видно *всё, что уже нарисовано*, и мы бы взялись это *всё* привести в соответствие со снимком, не забыв ни про одну точку. Часто настолько хорошего снимка у нас нет.

Иногда от корректировки формы зданий отделаться не удастся, даже если внутренности квартала нас не интересуют. Чтобы нарисовать то, ради чего мы и затеяли сдвиг, нам может быть нужна правильная длина зданий вдоль улицы. Например, в моём случае правильная длина бывает нужна для того, чтобы расставить внутри здания плотно идущие poi.[^8-poi-seq] Такая корректировка может потянуть за собой редактирование мест внутри квартала, если точки углов здания также входят в другие объекты. Ещё одним часто встречающимся случаем, требующем корректировки является промежуток в данных между стоящими в реальности вплотную зданиями. Он обычно возникает из-за тени на снимке от более высокого здания, падающей на более низкое.

[^8-poi-seq]: См. опять же неоднократно упомянутую запись [*Как я отмечаю POI – Геометрия*](https://www.openstreetmap.org/user/Anton%20Khorev/diary/45247).

С совмещением углов нам может и не повезти: все четыре угла могут на свои места не попасть. Тогда можно попробовать совместить три из них, а оставшийся угол поправить вручную. Причиной такой ситуации может быть то, что здания, которые должны были располагаться по одной линии, располагаются иначе. Одно из зданий может выпирать относительно своего соседа с одной стороны, а сосед с другой стороны и все последующие здания уже будут располагаться по новой линии. После сдвига квартала нам нужно будет либо подтянуть здания с одной стороны, либо отодвинуть с другой. Вдоль одной линии здания могут не оказаться из-за того же угла, под которым сделан снимок вместе с различной их высотой.

Если совместить со снимком не удаётся более одного угла, лучше отказаться от попыток сдвинуть квартал вручную и перейти к сдвигу по направляющим из [следующих двух глав](../9-guides/). Конечно, если расстояния, на которые углы отклоняются от целевых положений небольшие, то есть ненамного больше пары метров, мы можем этого не делать, а просто подравнять края зданий по нужной нам линии. Поскольку эту линию нам может понадобиться нарисовать, этот способ схож со сдвигом по направляющим. Основная разница для нас заключается в том, что мы можем ограничиться выравниванием только интересующих нас сторон квартала, а также в том, что мы можем обойтись стандартными средствами [JOSM](https://wiki.openstreetmap.org/wiki/RU:JOSM)'а без плагинов.

## Неправильные форма и размер квартала { #wrong-shape-and-size }

Форма квартала в данных может отличаться от правильной весьма существенно, так что никаких шансов сдвинуть его на нужное место нет. Такая ситуация может возникнуть из-за того, что разные части квартала рисовались по разным смещениям. Например, здания могли рисоваться относительно уже проведённых линий улиц. Сами же линии улиц были проведены кое-как, возможно даже немного в другом направлении. Разницы в направлении между тем, что в данных, и тем, что в реальности рисовавшие участники могли не заметить, если в первую очередь они ориентировались не на снимок, а на план, нарисованный на бумаге. Рисование на бумаге в процессе разведки на местности было распространено до развития мобильной техники, с помощью которой можно редактировать данные непосредственно, например, в vespucci.

Нарисованный на бумаге план накладывался на область редактирования в JOSM с помощью [плагина PicLayer](https://wiki.openstreetmap.org/wiki/JOSM/Plugins/PicLayer). Возможности этого плагина менялись со временем, и то, что вводилось с его помощью очень давно, могло пострадать от не слишком удобных средств позиционирования изображения. Собственно, средства были такие: перемещение, масштабирование, поворот. Конкретный сдвиг, угол поворота, увеличение задавалось перетаскиванием мышки. В изображении, полученном сканированием/фотографированием бумаги, информации о положении, ориентации и масштабе нет, так что от пользования этими средствами никуда не уйти. Любая неточность при наложении изображения добавлялась к неточностям рисования самого плана и неточностям его перерисовки в редакторе. Неточности при наложении же появлялись просто от того, что движение мышью даже на один пиксель могло вызвать слишком большой поворот или изменение масштаба. В какой-то момент пользователю надоедало бороться с PicLayer, и он решал, что и так сойдёт. Но что было приемлемо для того пользователя, может быть уже неприемлемо для нас.

Несколько более продвинутое средство в PicLayer появилось позже. Им была возможность совместить определённые точки изображения с определёнными местами на карте. Таких точек должно было быть ровно три, так как именно тремя точками задаётся линейное или, если хотите, [аффинное преобразование](https://wiki.openstreetmap.org/wiki/JOSM/Plugins/PicLayer#New_.cal_file_format), применяемое к накладываемому изображению. Наложить изображение, соответствующее кварталу, удобнее всего совмещением их углов. Проблема в том, что углов у квартала обычно четыре, и после совмещения трёх из них, четвёртый оказывается не на своём месте. Подвинуть его напрямую нельзя, можно только производить манипуляции с тремя другими углами, надеясь повлиять на оставшийся. Пользователю опять же могло надоесть этим заниматься, и оставленное им отклонение одного угла от трёх остальных искажало направление двух сторон квартала.

Я отдельно упомянул неправильный размер квартала. Смысл отдельного рассмотрения этого случая в том, что у нас есть теоретическая возможность избежать использования метода *сдвига по направляющим*. Практически окажется, что от этой возможности толка мало. Для начала посмотрим, как такое получается, что введённые данные квартала отличаются только размером. Наиболее вероятный сценарий их появления - тот же PicLayer, только теперь у вводящего данные имелся достаточно точный план. Сколь бы точным план не был, его всё равно надо масштабировать до нужного размера. Попытки делать это старыми версиями плагина нам уже известны: наложенное изображение будет либо чуть меньше, либо чуть больше, чем надо. Относительная ошибка будет достаточно небольшой, например 1%. Её может не заметить и сам пользователь.

Какая разница, если такая небольшая ошибка существует? Разница в том, что этот 1% может быть больше ширины тротуара. Как мы знаем, здания обычно рисуются до тротуаров, так что пользователя PicLayer, скорее всего, не волновало, что они будут накладываться друг на друга. Нас же это волновать может, поскольку рисование тротуара может являться нашей целью. Других участников такая ситуация может побудить на отрезание от зданий всего, что мешает провести тротуар. Мы, конечно, так поступать не будем. Можно вспомнить, что выше упоминалось выравнивание отдельных сторон, которое может и являться отрезанием, но использовать его рекомендовалось только для небольшого отклонения границы здания от желаемой линии. Если отклонение больше двух метров, лучше этим методом не пользоваться. Два метра - это ошибка в 1% для 200-метрового квартала, который типичен для исторического центра города. Если у нас квартал типа *советский микрорайон*, ошибка будет метров на пять.

Теперь перейдём к стандартному средству исправления неправильного размера. Ранее мы обратили внимание на то, что в режиме S помимо выделения есть и другие операции. Часть из них доступна при удерживании клавиш-модификаторов. Мы даже сделали примечание насчёт одновременного нажатия ctrl и shift. Теперь мы можем сказать, что перетаскивание мышки во время одновременного удерживания ctrl и shift позволяет {% action "Select#Rotate" %}вращать{% endaction %} выделенное множество элементов вокруг их центра. Нас сейчас интересует не эта, а другая операция, работающая подобным образом. Перетаскивание мышки при нажатых ctrl и alt приводит к {% action "Select#Scale" %}увеличению или уменьшению{% endaction %} элементов.

Значит, если размер квартала неправильный, мы можем попытаться сделать его правильным только что упомянутым перетаскиванием с ctrl и alt. Однако, поскольку управление этой операцией подобно аналогичному в PicLayer, нас ожидают и аналогичные проблемы. Нужный масштаб будет получить сложно, так как придётся совершать очень небольшие движения мышкой, следя за противоположными сторонами квартала. Часто при этом нет уверенности, что по завершении операции результат станет лучше. Было бы намного легче, если места для сторон квартала можно было выбрать по отдельности, что мы и проделаем, нарисовав для них направляющие линии.

## Недостаточная точность перемещения вручную

Наконец, точность любого сдвига вручную нас может не удовлетворять. Нам может быть нужно сдвинуть квартал на определённое расстояние с точностью выше метра. Причиной этого, скорее всего, не является то, что мы знаем координаты точек точнее метра. Требования к точности установки отдельных точек могут быть продиктованы соображениями симметрии, одинаковости расстояния, параллельности - тем, что мы проверяли в [главе про определение области сдвига](../5-area/). Соответственно, как минимум это служит для того, чтобы показать, что расположение объектов в данном месте не случайно. Мы можем даже захотеть так действовать из чисто эстетических соображений: на карте будет очень заметна разница между параллельными линиями и чуть-чуть непараллельными.

В эту ситуацию мы попадём, если выполним перерисовку осей. Мы, конечно, можем наоборот выполнить перерисовку осей, потому что нам нужен точный сдвиг, но это может быть не единственной причиной. Перерисовку мы можем затеять ради рисования тротуаров, если их не было, ради площадных улиц, ради газонов - то есть ради каких угодно объектов, вытянутых вдоль улицы. Если мы их собираемся нарисовать прямо, не имеет смысла криво переставлять квартал. Направляющие для его сдвига у нас будут уже готовы, и останется только ими воспользоваться.

Строго говоря, все направляющие будут готовы в результате перерисовки осей, если мы её выполним со всех сторон от квартала. Но мы можем и не выполнять перерисовки с каждой из сторон. Если мы не станем перерисовывать некоторые оси, которые нас и так устраивают, то из них мы получим оставшиеся направляющие без проблем. Но допустим, что на некоторые стороны и их оси мы совсем не хотим обращать внимания, и нас интересует только точная установка одной стороны квартала. Например, именно вдоль неё нам хочется нарисовать площадной тротуар определённой ширины. Тогда мы можем глядя на единственную направляющую линию сдвинуть квартал вручную, чтобы его край примерно с этой линией совпадал. Дальше мы можем подравнять край по линии, то есть сделать так, чтобы точки края оказались на линии при том, что линия остаётся на месте, и этого будет достаточно. Примерно так же можно поступить и для точной установки двух смежных сторон квартала.

Теперь предположим, что направляющие у нас есть со всех сторон, и хотим мы точного позиционирования тоже со всех сторон. Мы можем попытаться тоже сдвинуть квартал вручную так, чтобы его края примерно совпадали с направляющими, а затем края подравнять, но делать это окажется неудобно. При сдвиге нам понадобится следить за положением перемещаемого квартала относительно направляющих. В описанной выше ситуации с одной или двумя направляющими, образующими угол, сделать это было не так сложно. Однако теперь у нас есть направляющие с противоположных сторон квартала. Противоположные стороны будет видно в окне редактирования только на таком увеличении, на котором уже плохо видны детали и нельзя сделать достаточно тонкий сдвиг. Если приблизиться, будет видно лишь одну сторону или один угол, и будет неясно, что при сдвиге происходит с противоположной стороны. Увидеть сразу всё, что мы хотим, нам помог бы *split view*, если бы он в JOSM'е был. И, конечно же, у нас совсем не получится подвинуть квартал вручную под направляющие, если у него не совпадает с ними форма или размер.
