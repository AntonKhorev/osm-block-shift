---
title: Предлагаемые действия
---

Итак, вы находитесь в ситуации, когда вам надо добавить какие-либо данные, но сделать это затруднительно из-за несоответствия реальности уже имеющихся данных. Всё это рассматривается применительно к городским условиям, когда данные необходимо добавить либо внутри квартала, либо рядом с ним. Под несоответствующими реальности данными, доставляющими неприятности, подразумеваются значительные объекты, относительно которых имеет смысл вводить другие данные. Несоответствия у этих значительных объектов и мешают относительному вводу. В наших условиях это в первую очередь здания, что мы далее и будем подразумевать, хотя это могут быть и другие объекты. Несоответствие должно быть устраняемо в достаточной для нас степени сдвигом части данных, что мы и хотим проделать.

В более общем случае у нас может возникнуть желание сдвинуть данные и по соображением, не включающим в себя ввод новых данных. Тем не менее, саму возможность ввода надо иметь в виду, так как после нашего сдвига добавлять данные может захотеть и другой участник. Значит, надо исправлять одни данные так, чтобы при этом как можно меньше искажать их в других местах, иначе подобные проблемы возникнут и там. Отсюда следует выбор сдвигаемой области: её граница должна проходить через такие места, где данных меньше, где взаимное расположение объектов на противоположных сторонах менее важно, где вносимые сдвигом искажения легче устранить. В нашем случае сдвигаемой областью является квартал.

## Редакторы

В качестве редактора мы выберем, конечно же, josm. Подходящих альтернатив у него просто нет. Многие, пытающиеся описанным выше способом исправлять уже введённые данные, делают это из iD. Из iD сделать правильно то, что мы хотим, практически нереально. Более того, этот редактор вообще не подходит для модификации существующей геометрии. Поскольку данный редактор находится [в одном клике](https://www.openstreetmap.org/edit) от просмотра карты на сайте, он считается редактором для новичков. На самом деле iD является редактором для добавления и незначительного изменения данных в тех случаях, когда на компьютере не установлен более подходящий редактор. Новичкам пользоваться iD для исправления существующей геометрии не следует, так как результат может оказаться противоположным. Из iD достаточно легко, легче, чем из josm, вносить новые ошибки, в частности из-за того, сколько различных действий закреплено за левой кнопкой мыши. Впрочем, в josm их тоже закреплено немало, что нам предстоит увидеть.

Из прочих редакторов нам по очевидным причинам не подойдут те, которые предназначены для редактирования poi, например, OsmAnd и maps.me. Раз уж речь зашла о мобильных редакторах, то придётся признать неподходящими их все. Хоть какие-то шансы есть у vespucci, так как он предназначен для редактирования геометрии. Предназначен он для этого, правда, относительно своей платформы, так как из iD на компьютере редактировать было бы легче. На мобильных же устройствах вариантов лучше нет.

Пользуясь vespucci вы можете оказаться в описываемой ситуации, когда надо что-то дорисовать, а введённые здания мешают. Но двигать существенные количества элементов в этом редакторе вы всё равно не будете, особенно с помощью сенсорного экрана. Вместо сдвига квартала имеет смысл сдвинуть снимок под то смещение, которое у данных уже есть, и рисовать по нему. Потом, добравшись до компьютера с josm, можно будет уже сдвинуть всё, как положено. И уж точно вы не будете из vespucci делать откаты.

Ожидаемо отказавшись от веб- и мобильных редакторов, можно посмотреть, что ещё доступно для ПК. Обнаружить чего-либо подходящего, помимо josm, однако, не удастся. Из собственно редакторов, а не плагинов к чему-нибудь ещё, можно назвать разве что [Merkaartor](https://wiki.openstreetmap.org/wiki/Merkaartor). В этом не сильно поддерживаемом и не сильно используемом редакторе можно отметить разве что обобщение функции ортогонализации на большее количество осей, чем две, но пришли мы не за этим. Сам josm в стандартной комплектации нам тоже не подойдёт, к нему придётся устанавливать плагины.

Раз уж мы заговорили обо всех возможных редакторах, охарактеризуем общее положение дел с ними. Оно обусловлено восприятием того, что каких-либо данных в осме нет, и их надо любой ценой добавлять. Соответственно, инструменты редактирования предназначены в первую очередь для первоначального добавления данных. Мы же находимся совсем в другой ситуации. Правки, которые мы собрались проделать, будут преимущественно состоять из преобразования существующих данных, а иногда и исключительно из него. К подобной ситуации постепенно придёт любое место, которое редактируется на протяжении значительного времени. Если редакторы соответствующим образом не изменятся, то они будут всё хуже и хуже подходить для редактирования.

## Плагины

Вернёмся к плагинам для josm, которые нам могут понадобиться. Вот они:

* [utilsplugin2](https://josm.openstreetmap.de/wiki/Help/Plugin/UtilsPlugin2) - для выделения области сдвига;
* [CommandLine](https://wiki.openstreetmap.org/wiki/RU:JOSM/Модули/CommandLine) - для сдвига, если обычное перетаскивание мышкой недостаточно точно; если нужно более хитрое преобразование, чем просто перемещение, понадобится ещё мой набор скриптов к нему;
* [imagery_offset_db](https://wiki.openstreetmap.org/wiki/RU:Imagery_Offset_Database) - может быть нужен, если вы хотите воспользоваться смещением снимка, определённым другим участником;
* [alignways](https://wiki.openstreetmap.org/wiki/JOSM/Plugins/AlignWayS) - может пригодиться для выравнивания отдельных отрезков линий относительно других отрезков;
* [reverter](https://wiki.openstreetmap.org/wiki/JOSM/Plugins/Reverter) - для откатов отдельных пакетов или выделенных элементов из отдельных пакетов.

Плагины можно установить из меню josm *[Edit > Preferences > Plugins](https://josm.openstreetmap.de/wiki/Help/Preferences/Plugins)*.

К плагину CommandLine прилагается стандартный набор скриптов, и некоторые из них нам могут понадобиться. При перезапуске josm плагин предложит их установить. Однако работать они не будут, если также не установлен python, на котором скрипты и написаны. Python должен быть доступен именно по команде `python`, а не `python3`, как это будет, например, в Ubuntu 24.04. В данном случае это легко исправляется с помощью `sudo apt install python-is-python3`.

Нам также могут понадобиться и другие скрипты, которых в этом наборе нет. Это скрипты, написанные автором данной записи, и они [доступны на GitHub](https://github.com/AntonKhorev/JOSM-CommandLine-commands). Включить в общий набор скриптов их так и не удалось, поскольку автор плагина [перестал принимать пулл-реквесты](https://github.com/Foxhind/JOSM-CommandLine-commands/pull/11). Чтобы поставить дополнительные скрипты, нам надо проделать то же самое, что написано на вики-странице плагина про стандартные, но в качестве архива взять [zip-файл из форка](https://github.com/AntonKhorev/JOSM-CommandLine-commands/archive/master.zip). Первым делом надо обнаружить, в каком каталоге находятся стандартные скрипты, потому что информация в вики на этот счёт может быть устаревшей. В случае Ubuntu 24.04 и josm 19423 скрипты находятся в `~/.local/share/JOSM/plugins/CommandLine`. Там должны быть файлы `arc.py`, `arc.xml` и т.д. После распаковки дополнительных скриптов там же должны оказаться и `transform3.py`, `transform3.xml`, `transform4.py`, `transform4.xml`. Чтобы новые скрипты появились в меню *Commands*, josm надо перезапустить.

## Режимы и команды

Поскольку действия из josm мы будем рассматривать на протяжении оставшейся части записи, договоримся об их обозначениях. Для краткости мы будем называть режимы и команды по клавишам, на которые надо нажать, чтобы их выполнить. Например, команду выстраивания точек по прямой мы будем называть командой L. Так как многие из команд придётся использовать довольно часто, клавиши для их вызова имеет смысл запомнить, чтобы не искать соответствующих пунктов меню и вообще не отодвигать мышиный курсор от редактируемого места. Некоторые из режимов требуют для активации повторного нажатия клавиши, и их мы будем обозначать двойной буквой. Например, режим лассо мы будем называть режимом SS.

Конечно, никто не мешает нам переопределить клавиши, и тогда используемые здесь обозначения будут уже не столь полезны, но можно предположить, что большинство пользователей для большинства команд переопределений не делают. Помимо запоминания клавиш, у нас имеется и другая причина называть по ним режимы. Как выяснится, в отдельном режиме могут быть доступны разные операции, хотя называют его по какой-то одной из них. В этом может не быть ничего странного, ведь из всех операций часто можно выделить основную или охарактеризовать их как-либо вместе. Мы же в данной записи иногда будем пользоваться только неосновной операцией режима, и тогда его *правильное* название будет для нас неактуальным. Более того, разработчики josm могут *правильное* название поменять.[^4-x] Также обозначения по клавишам позволят нам в меньшей степени обращать внимание на то, какой включен язык интерфейса, и как на этот язык переведены названия режимов и команд.

[^4-x]: В последних версиях josm это произошло с режимом X, который мы используем по неосновной операции. Хотя разработчики могут и клавишу поменять, что произошло несколько лет назад с режимом удаления, но мы этот режим рассматривать не будем.

## План действий

Наша операция сдвига будет состоять из нескольких шагов. Не все шаги будут обязательны во всех ситуациях, так что у нас будет несколько вариантов действий. В большей степени необходимость делать определённый шаг будет зависеть от уже введённых данных. Также она будет зависеть от нашего желания получить большее качество или сэкономить время. Все рассматриваемые в этой записи действия, а также те, рассмотрение которых пришлось отложить, можно представить в виде блок-схемы:

(В данном месте должна быть блок-схема, которая, кажется, существует на листе бумаги. Этот лист надо найти.)

Самый простой вариант действий потребует от нас три клика и одно перетаскивание. Он применим в том случае, когда данные квартала уже готовы к выбору, относительных искажений в них нет, и мы считаем себя способными поставить квартал на нужное место простым перетаскиванием. Шаги этого способа действий находятся в левой части схемы. Справа же находится потенциально весьма трудозатратный способ, на который может уйти больше часа. Он заключается в *рисовании осей* улиц, проходящих мимо квартала, а затем в выравнивании вдоль них прочих линий, включая направляющие перемещения квартала. С этим способом придётся возиться вместо того, чтобы заниматься теми данными, которые мы собирались вводить до того, как обнаружили необходимость сдвига. Впрочем, мы можем от него временно отказаться, и заняться им позже. Нам придётся отказаться и от полного рассмотрения этого способа в данной записи из-за её и без того чрезмерного объёма. Рассмотреть этот способ имеет смысл в своей собственной записи, так как результат его применения может интересовать нас и сам по себе.

В процессе редактирования нам может потребоваться построение временных линий, которые мы удалим перед отправкой результата на сервер. Этими построениями являются:
* рисование границы области сдвига относительно текущего расположения данных квартала;
* восстановление углов квартала в данных квартала;
* рисование направляющих линий относительно целевого положения;
* рисование осей улиц относительно целевого положения квартала и самих улиц вместе с линиями, позволяющими их более точно расположить.

Последнее соответствует трудозатратному способу, и может понадобиться для рисования направляющих, если нам не повезло. Повезёт нам, если в данных уже есть достаточно качественные линии, идущие по осям или параллельные им. Не все из временных линий совсем пропадут. Некоторые из них можно переделать в {% tag "landuse" %}, {% tag "area:highway" %} и прочие объекты, если у нас найдётся желание отвлечься на их рисование.
