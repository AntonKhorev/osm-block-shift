---
title: Подготовка к сдвигу по направляющим
---

## Чего мы хотим

Когда мы хотели выделить весь квартал, что было во времени выполнения операции несколько секунд назад, а во времени чтения данной записи несколько минут, а то и полчаса, мы рисовали вокруг него замкнутую линию. Сейчас мы нарисуем ещё одну линию, теперь уже на том месте, на которое мы хотим квартал переместить. Делая это, мы получим те же преимущества: линию можно подправлять всеми доступными средствами редактирования геометрии до тех пор, пока её положение не будет нас удовлетворять. Таким образом результат сдвига не будет зависеть от того, дрогнула ли у нас рука, когда мы перетаскивали квартал, и хватило ли у нас внимания, чтобы проследить за всеми его местами, которые мы пытались сопоставить со снимком.

Строго говоря, одну замкнутую линию нам рисовать теперь не обязательно. Для выполнения сдвига линии нам вообще не нужны. Нужны нам лишь точки углов целевого места, на которые мы, вызвав скрипт для [CommandLine](https://wiki.openstreetmap.org/wiki/RU:JOSM/Модули/CommandLine), перетащим точки углов нарисованного квартала. В результате перетащится и всё остальное, что было выделено с помощью предыдущей замкнутой линии или каким-либо другим способом. Но линии нам всё равно пригодятся для визуальной оценки результата и для окончательного выравнивания сторон квартала. Так что линии по сторонам целевого положения квартала, которые мы называем *направляющими*, мы нарисуем.

В отличие от линии для выделения, направляющие линии для сдвига надо рисовать гораздо точнее. Линия границы области сдвига должна была оказаться с одной стороны от некоторых элементов и с другой от некоторых других. Во многих случаях для этого достаточно ткнуть несколько раз мышкой в промежутки между элементами. Никаких проблем попасть мышкой в промежуток у нас не будет, потому что мы можем увеличить его, насколько нам захочется. Под каким углом относительно чего угодно проходят отдельные отрезки границы нас совсем не интересует. При рисовании направляющих для нас уже будет иметь значение и что под каким углом идёт, и где какие углы расположены. В принципе, для работоспособности скрипта точность направляющих не важна, но тогда нам не нужны такие сложности, и сдвига вручную оказалось бы достаточно.

Предположим, что точность нас интересует. Тогда направляющие нам будет легче задать в виде отдельных линий для каждой из сторон квартала, а не в виде одной замкнутой линии. Собственно поэтому мы и говорим о них во множественном числе. Рисование отдельных линий для каждой из сторон позволит их перемещать, не затрагивая остальные стороны. Нужные для скрипта точки углов мы получим после установки линий сторон в точках их пересечений.

Нашей первой задачей является выбрать сторону квартала, провести вдоль неё линию, потом выбрать другую сторону, снова провести линию и так далее, пока мы не получим линии со всех сторон. Проводя каждую линию мы решаем две задачи: определение её направления и определение её смещения. Мы их можем захотеть рассматривать отдельно, потому что одна из них, обычно определение направления, может быть уже решена. Их важность тоже может быть различна: при достаточно неправильном направлении линии смещение точек на ней не удастся держать в допустимых рамках.

Провести линию мы можем либо на основании снимка, либо на основании другой линии в имеющихся осмовских данных, а может даже и на основании отдельно сохранённых нами вспомогательных данных. Вряд ли мы станем проводить её на основании тех объектов которые мы сдвигаем. Их расположение мы уже признали неправильным, так что в лучшем случае мы могли бы получить из них направление, но и это маловероятно. В первую очередь основой для направляющей линии выступает линия улицы. Мы попытаемся получить из неё параллельную ей линию, находящуюся на границе квартала, для чего мы будем сдвигать эту линию, сопоставляя её со снимком. В этот момент мы можем обнаружить, что эта задача так просто не решается, например, потому что наша линия на самом деле непараллельна границе, или что то, что мы хотели использовать в качестве границы, недостаточно хорошо видно на снимке. Тогда нам придётся поменять стратегию и провести линию на основании чего-то другого.

## Расположение направляющих

Прежде чем рассматривать рисование направляющей линии, разберёмся с тем, где именно мы её хотим провести. В самом простом случае, который мы и считали имеющим место, направляющая линия проводится *по границе зданий со стороны улицы*. В итоге весь квартал оказывается внутри "рамки", образованной направляющими с разных сторон. Для того, чтобы этот случай на самом деле был, должно выполняться несколько предположений. К счастью, далеко не все из них нам на самом деле нужны.

Для того, чтобы провести направляющую линию по зданиям, нужно, чтобы на границе квартала располагались здания. Для того, чтобы провести её в виде прямого отрезка, нужно, чтобы здания располагались по прямой. Это часто бывает верно для плотной застройки в центре города. Впрочем, верно это не в полной мере. Отдельные здания могут не находиться на одной линии с остальными. У зданий могут быть части, отклоняющиеся от линии. Между зданиями могут быть промежутки. Подобные вещи не являются для нас проблемой и обычно их можно игнорировать. Направляющая линия нам нужна на месте той линии в реальности, по которой выстроено большинство зданий. Желательно, чтобы по ней шли угловые здания, так как после рисования направляющих мы хотим получить точки углов квартала. Нас устроит даже, если на одной линии находятся только угловые здания, а расположение объектов между ними для нас не так важно. Если из общего строя выбивается угловое здание, то и это не существенная проблема, а лишь дополнительная сложность. Направляющую линию мы в этом случае проведём по той реальной линии, по которой построена основная часть зданий, а то, что мы будем считать углом квартала просто не будет углом здания.

{% TODO %}фотка: здания не на одной прямой{% endTODO %}

Теперь направляющая линия для нас - это такая *линия, по которой в реальности расположена существенная часть зданий*, причём зданий иногда достаточно двух, и этой линии мы можем сопоставить элементы зданий в данных квартала. В конечном итоге сопоставлять будем не мы, а скрипт, и не линии, а точки их пересечения, то есть углы, поэтому линию мы продлим до протяжённости квартала. Для нас желательно проводить направляющую линию по угловым зданиям как раз для того, чтобы её продлевать было не нужно. Также это желательно для того, чтобы в сдвигаемых данных уже были точки, соответствующие точкам пересечения направляющих, которые в противном случае придётся дорисовывать.

Итак, отдельные отклонения зданий от направляющей линии не являются проблемой. Можно вспомнить выпирающие части зданий и то, какие неприятности они могли нам доставить при рисовании границы области сдвига. Тогда для нас было весьма желательно, чтобы квартал оказывался целиком внутри проведённой вокруг него линии. Теперь же, при рисовании направляющих, у нас такого строгого требования нет. То, что часть точек окажется после сдвига за пределами рамки из направляющих, нам никак не помешает. Множество перемещаемых элементов этой рамкой не определяется. Мы стремимся к тому, чтобы значительная часть квартала оказалась внутри рамки, потому что так нам легче нарисовать эту рамку, легче убедиться в правильности направления её сторон, и в результате получить минимум искажений.

Мы можем себе представить абсурдный вариант применения сдвига по направляющим. Выберем небольшое прямоугольное здание посреди квартала, например гараж. Обведём его на снимке с нужным нам смещением и станем считать это направляющей линией. Применим скрипт, как это будет описано ниже, к углам этой направляющей и уже нарисованного, но смещённого гаража. В результате гараж точно попадёт на указанное нами место. Куда при этом попадут края квартала - неизвестно, но вряд ли они окажутся там, где мы хотим. Если бы мы провели направляющие линии ближе к краям, края бы оказались ближе к цели. Если бы провели направляющие точно по краям, то края, если они прямые, оказались бы точно на направляющих.

Обычно мы и хотим сдвинуть квартал так, чтобы со своим реальным положением совпадали в первую очередь его края. Так неточности внутри квартала становятся его внутренними проблемами, которые можно исправлять независимо от того, что находится за его пределами. Если же квартал своими краями перекрывает места, которые должны быть за его пределами, проблемы выносятся наружу и затрагивают внешние по отношению к кварталу данные. Всю операцию со сдвигом мы затеяли для того, чтобы такие внешние проблемы устранить. Устраним, правда, мы их не полностью, о чём пойдёт речь в соответствующем разделе про поправки после сдвига.

Направляющая линия внутри квартала не даст нужного результата в плане выравнивания его краёв не только потому что она далеко от них. Внутри квартала также будет сложнее найти достаточно длинный отрезок прямой, вдоль которого что-либо построено и который было бы хорошо видно на снимке, а чем короче отрезок, тем менее точно мы воспроизведём его направление. В итоге всё, что мы сдвигаем, окажется повёрнуто и перекошено. Так что мы хотим целиться по чему-то длинному прямому на краю квартала или очень близко к нему. Однако мы ещё можем расслабить наши требования к направляющим.

Выше мы решили, что по направляющей линии построены здания. На самом деле, нам не важно, что именно построено по этой линии. Важно, чтобы оно было нарисовано в сдвигаемых данных, то есть, чтобы в данных было то, что мы попытаемся с направляющей линией совместить. Неважно даже, построено там что-либо, или оно там появилось любым другим способом. Важно, чтобы оно *было на линии, было видно на снимке и было в сдвигаемых данных*. О зданиях мы говорили потому что рисовать квартал начинают именно с них, и часто кроме них ничего подходящего для направляющей нет. Кроме того, здания чаще пытаются рисовать так, чтобы их положение друг относительно друга имело смысл: без этого не обойтись, если здания расположены вплотную. Другие кандидаты для направляющих, если они и нарисованы, могут располагаться в данных не вполне правильно относительно зданий. Мы уже рассматривали в разделе про выбор области сдвига газоны, идущие вдоль улицы, и заметили, что они бывают нарисованы очень криво, из чего следует, что для направляющих они не годятся.

Не годятся газоны обычно для сопоставления своего изображения на снимке со своим же изображением в данных. Зато они могут годиться для сопоставления своего изображения на снимке с прочими объектами в данных. В первую очередь речь идёт о газонах между или рядом со зданиями, располагающимися с ними на одной линии. Края газонов на снимке могут быть видны гораздо лучше, чем края зданий, зато здания бывают лучше отражены в данных. В таком же качестве ориентира на снимке часто выступают также заборы, хотя подойти может что угодно, у чего есть  прямой хорошо видный край. С этим краем мы можем сопоставить направляющую линию, к чему мы ещё вернёмся ниже, когда будем говорить непосредственно про рисование направляющих.

Только что сказанное про газоны и заборы означает, что направляющую мы обычно пытаемся расположить всё равно по краям зданий, хотя на снимке мы не всегда ищем непосредственно эти края. Сопоставить нам нужно линию на снимке с линией в данных, а объекты, которые мы ищем и там, и там, не обязаны полностью или даже в одинаковых местах покрывать отрезок этой линии вдоль квартала. Впрочем, иногда газон или забор могут являться одним из ориентиров и в данных, особенно, когда они расположены на углу квартала. Тогда они могут играть роль, аналогичную угловым зданиям, и их угловая точка будет сопоставляться с точкой пересечения направляющих. Обычно же газоны и заборы такой значительной роли не играют, и выступают лишь как продолжение линии зданий в тех местах, где она прерывается.

{% TODO %}фотка: перекрёсток корсакова-вознесенский: угловой дом не на линии, зато есть другой ориентир - газон и забор{% endTODO %}

Когда мы говорим про меньшую значимость заборов относительно зданий, мы имеем в виду застройку, типичную для центра города. Для мест, больше похожих на посёлок, заборы выйдут на первый план, если они уже есть в данных. Для начала предположим, что заборов нет. В этом случае у нас имеются небольшие здания с большими промежутками между ними, из чего следует, что их взаимное расположение не столь важно. Также здания расположены на достаточном расстоянии от улицы, в результате чего и их абсолютное смещение менее важно. Если в данных уже нет каких-то объектов, расположенных вплотную друг к другу в пределах квартала и относительно улицы, использовать сдвиг по направляющим нам и не понадобится, да и сами направляющие нам рисовать не по чему. Мы можем ограничиться сдвигом вручную всего квартала и последующими сдвигами вручную отдельных объектов или даже только сдвигами отдельных объектов, если их мало.

Другое дело, если заборы нарисованы. Тогда они сами являются вплотную расположенными объектами, взаимное положение которых важно. Важно оно как непосредственно для самих заборов, так и для участков, материальным выражением границ которых заборы и являются. Заборы, видимые на снимке как прямые отрезки, являются подходящими ориентирами для направляющих, которые потом будут сопоставлены с заборами в данных. То есть, заборы дают нам как причины использовать сдвиг по направляющим, так и места для рисования направляющих. Можно попробовать сделать и общее утверждение: если у нас нет подходящих мест для направляющих, то нам не нужно использовать сдвиг по направляющим.

Конечно, возможны и промежуточные ситуации между центром города и посёлком. Внутри квартала может находиться много объектов, взаимное расположение которых важно, при этом некоторые из них могут быть близко к улице, но так, что направляющую по ним не провести. При этом в реальности подходящая линия наверняка есть, но её нет в данных. Например, такой линией могла бы быть граница тротуара и проезжей части, которая обычно прямая и хорошо видна. В данных она бывает редко, а если она и есть, то нарисована она не обязательно относительно зданий, определением чего мы занимались в разделе про выбор области сдвига. Наиболее вероятным кандидатом для направляющей будет противоположная граница тротуара, по которой может идти газон. Проблема, опять же, в том, что он часто не нарисован или нарисован криво. Если так, то нам тоже лучше отказаться от сдвига по направляющим, и двигать объекты только вручную, уделяя особое внимание точкам рядом с улицей.

## Направляющие точки?

Можно снова вспомнить, что для непосредственного выполнения сдвига направляющие не нужны. Чтобы выполнить сдвиг рассматриваемыми далее скриптами, достаточно указать три или четыре *целевые точки* и соответствующие им *исходные точки*. Целевые точки - это те точки, которые находятся в идеальном случае на углах квартала, и их конкретное положение определяется не осмовскими данными, а тем, подо что мы хотим данные подогнать, обычно снимками. При обычном порядке действий целевыми точками являются пересечения направляющих линий. Мы можем попытаться поставить их и без рисования направляющих линий, и тогда целевые точки сами можно будет назвать направляющими в том смысле, что по ним можно восстановить линии. Впрочем, в общем случае соседние целевые точки могут и не находиться на какой-либо определённой линии.

Устанавливать целевые точки без направляющих линий - это, как правило, не лучший способ действий. В крайнем случае так поступить можно, но обычно это более сложный путь. Проводя сначала линии, мы пользуемся большим количеством ориентиров и получаем более точные положения целевых точек. Точность тут важна не только абсолютная, но и относительная. С линиями мы явно видим положение одного угла границы квартала относительно другого угла, потому что линии их соединяют. Игнорирование этого относительного положения приведёт к перекосу сдвигаемых данных, подобному тому, который мы ожидали увидеть при абсурдном использовании гаража в качестве направляющей.

Перекос при сдвиге возможен, потому что его допускают средства сдвига, описываемые в данном разделе. Допускают они его специально, чтобы загнать квартал в рисуемую нами рамку из направляющих. Если мы рамку не рисуем, может нам и средство использовать такое, которое перекосов не допускает? Понятно, что таким средством является сдвиг вручную, при котором мы не указываем ни направляющих линий, ни целевых точек. Но, допустим, что точки мы указать хотим. От их количества зависят необходимые преобразования, чтобы поставить на их место исходные точки. Чем больше точек, тем более сложное преобразование нам потребуется.

Для трёх целевых точек необходимо линейное преобразование общего вида, включающее перекос. Значит, если перекосов мы не хотим, нам придётся использовать меньшее количество точек. Для двух точек хватит только операций сдвига, масштабирования и поворота. В этой записи мы не будем рассматривать такой подход, потому что поворот удовлетворительного качества без направляющей линии сделать сложно, то есть легко сделать хуже, чем было до того. Для одной точки достаточно операции сдвига, который подобен сдвигу вручную, но благодаря указанию точки можно получить большую точность.

Получается, что если направляющие линии мы указать не можем, но точки указать, тем не менее, хотим, обычно единственным имеющим смысл вариантом действий является указание одной целевой точки. В [стандартном наборе скриптов для CommandLine](https://wiki.openstreetmap.org/wiki/RU:JOSM/Модули/CommandLine#Стандартные_команды) эта операция уже реализована в виде команды Move. Применение её выглядит так: сначала вы указываете множество сдвигаемых элементов, потом исходную точку, потом целевую точку. Скрипт синхронно сдвигает все элементы так, чтобы исходная точка попала на место целевой. На самом деле, исходная точка может и не входить во множество сдвигаемых объектов, а целевая - входить. Более того, эти точки могут являться не осмовскими элементами, а произвольными точками пространства, то есть любыми парами координат. Тогда принцип работы скрипта надо уточнить: *он синхронно сдвигает выбранные элементы так, чтобы если вместе с ними сдвигалась бы и исходная точка, она оказалась бы на том месте, где до сдвига была целевая точка*.

[Параметры](https://wiki.openstreetmap.org/wiki/RU:JOSM/Модули/CommandLine#Передача_параметров) исходной и целевой точки скрипт принимает просто в виде координат, которые можно задать, ткнув на элемент-точку, на произвольное место в окне редактирования или даже введя их как пару чисел. С интересующей нас точностью мы можем их задать кликом по элементу-точке, что мы и будем делать дальше. Делать мы это будем не только и не столько для скрипта Move, сколько для рассматриваемых далее скриптов, передача параметров-точек которым производится аналогично. Скрипт Move же для сдвига всего квартала существенных преимуществ по сравнению со сдвигом вручную не даёт из-за того, что целимся мы всего лишь по одной точке. Он и его вариант с копированием более полезен для сдвига мелких объектов.

Вернёмся к нескольким целевым точкам. В какой ситуации мы бы могли воспользоваться точками без рисования направляющих линий? Представим себе участок, который ещё только застраивается, и улицы у него есть не со всех сторон. На одной из сторон никакой прямой, по которой мы могли бы провести направляющую ещё нет. Первое, что стоит попробовать - это взять подходящую прямую с противоположной стороны, но такой прямой может тоже не быть, да и стороны участка могут оказаться непараллельными. Теперь, если мы всё ещё намерены воспользоваться скриптами, нам придётся искать хорошо различимые точечные объекты рядом с теми углами участка, у которых нет двух пересекающихся направляющих.

Подходящим объектом мог бы быть столб на углу участка. Он, скорее всего, виден со всех сторон, а, значит и с той, с которой сделан снимок. Он стоит на земле, и видно его основание. Это позволит достаточно точно получить его координаты. Правда, всё это не будет иметь смысла, если столб отсутствует в уже имеющихся осмовских данных. Его присутствие в данных не слишком вероятно, потому что столбы сами по себе не очень интересуют мапперов. Более того, даже если он и присутствует, нам нужна уверенность, что отмечен он согласно тому же смещению, что и большая часть сдвигаемых объектов. Уверенность мы можем попытаться обрести, сдвигая снимок под смещение существующих данных.

Описанная выше ситуация маловероятна, потому что никакого столба на углу, скорее всего, нет, а если он и есть, то его никто не отметил. Какие ещё объекты могли бы подойти в качестве целевых точек? Может быть, наш столб входит в забор и находится на углу, или есть просто угол забора, не обязательно составленного из столбов. Заборы отмечают гораздо чаще, либо как самостоятельные объекты, либо как границы чего-то другого, чем в нашем случае может быть стройплощадка. Но забор это также потенциальная направляющая прямая, которую нам следует попытаться провести, прежде чем переходить к непосредственной установке целевых точек. Пытаться использовать только угол нам понадобится, если направление прямой части забора не совпадает с направлением стороны участка, или если прямой части не существует.

Можно представить себе и здание на углу участка, у которого нет достаточно прямых или достаточно длинных стен для построения направляющих линий, зато есть угол. Использовать угол здания для направляющей точки выглядит логичным, ведь мы при нормальном развитии событий и получаем точки, соответствующие углам зданий. Но отдельно взятый угол здания гораздо менее удобен для решения нашей задачи, чем угол забора или отдельно стоящий небольшой объект.

Во-первых, угол здания может быть срезан или как либо ещё не соответствовать геометрической точке. С этим явлением мы при нормальном развитии событий и боремся построением направляющих линий и нахождением точки их пересечения. Сейчас же мы решили от линий отказаться, что делает положение угла менее определённым и менее пригодным быть целевой точкой. Во-вторых, угол может быть недостаточно хорошо виден, так как его на снимке может скрывать само здание. Хорошо будет виден угол крыши, но это не та точка, которая нам нужна. Нужен нам угол на уровне земли, а крыша может быть смещена из-за направления снимка. Даже если она не смещена, она может быть шире самого здания, так что её угол всё равно не совпадёт с нужной нам точкой. Со всем этим мы, опять же, могли бы справиться с помощью направляющих линий, которые можно проводить относительно нескольких объектов и на определённом расстоянии от более хорошо обозреваемых объектов. Поскольку от линий мы отказались, угол придётся искать без помощи более заметных ориентиров.

Если мы хотим задать более трёх целевых точек, появляется ещё одно отрицательное последствие отказа от направляющих линий. Используемое в этом случае преобразование по-разному относится к различным направлениям линий в преобразуемых данных. Линии вдоль некоторых направлений деформируются меньше других, и наиболее точно передаются именно те из них, которые лежат на направляющих. Действительно, при нормальном развитии событий именно эти направления для нас наиболее важны. Отказавшись от направляющих линий и располагая целевые точки независимо друг от друга, мы теряем направления, вдоль которых искажения были бы минимальны. Это не значит, что все прямые обязательно изогнутся, ведь мы в любом случае задаём точки рядом с углами, следовательно, "точные" направления будут близки к нужным. Однако, чем более свободно мы позволим себе ставить целевые точки, тем хуже будет результат сдвига квартала.

Итого, задавать целевые точки без направляющих линий в принципе можно, но вряд ли ситуация будет для этого удобна. Результат может получиться хуже того, что было, потому что данные окажутся повёрнуты относительно того направления, в каком должна была проходить направляющая линия. Использование направляющих линий позволяет такого поворота избежать.

## Рисование направляющих

Итак, мы имеем представление о том, где должны проходить направляющие линии. Теперь мы хотим их нарисовать, что мы проделаем отдельно для каждой из сторон квартала. При этом для каждой из сторон мы можем пользоваться разными способами рисования направляющей. Ранее задачу рисования мы поделили на две части: определение направления и определение смещения, причём мы надеемся, что первая из них уже решена.

### Направление по готовой линии, смещение по снимку

Первый способ, который мы попробуем, соответствует нашим надеждам на то, что направление уже готово. Направление может быть зафиксировано в любом достаточно длинном прямом отрезке, параллельном стороне квартала. Наиболее вероятным кандидатом этого является линия улицы. Насколько она на самом деле прямая, мы могли уже проверить на этапе выбора области сдвига. Если мы воспользуемся описываемой предположительно в одной из следующих записей *перерисовкой осей*, у нас может быть готова и другая линия, про которую нам уже известно, что она подходит. Также нам может быть понятно, что никакой готовой подходящей линии у нас нет, в случае чего мы можем перейти либо к следующему способу, либо к перерисовке осей. Ещё возможен вариант, когда мы не уверены, подходит линия в качестве указания направления. Тогда мы продолжим действовать согласно данному способу, в процессе чего мы и обнаружим, насколько линия на самом деле подходит.

Итак, у нас есть линия, которую мы будем называть *осевой*, хотя строго по оси улицы ей идти не обязательно. Мы хотим провести параллельную ей линию, которая и станет *направляющей*. Для этого мы воспользуемся режимом параллельных линий, теперь уже для рисования, а не просто как линейкой. Рисовать новую линию мы хотим независимо от уже введённых данных самого квартала, так что нам удобнее их скрыть. Легче всего это сделать созданием нового слоя и рисованием на нём. Слой нам может и не захотеться создавать, если мы посчитаем, что справимся и без этого, особенно, если осевая находится в одном слое с данными квартала.

Если мы решимся на создание нового слоя, где в итоге должна оказаться рамка из направляющих, то туда также надо скопировать и осевую. После копирования мы можем сразу убрать с осевой лишние теги и точки. Как мы знаем, в режиме параллельных линий все точки и теги копируются, если не принять против этого дополнительных мер. Теги на копии осевой нам не нужны вообще, особенно на её точках, но если мы используем в качестве осевой линию улицы, то они там будут. Если копировать осевую нам было лень, то удалять с неё, само собой, ничего не следует. Тогда вместо этого нужно удерживать Alt в момент начала перетаскивания, что означает, что Alt *нужно* нажать *до* нажатия кнопки мыши, и Alt *можно* отпустить *после* нажатия кнопки мыши. Это неудобно, как само по себе, так и по некоторым другим причинам, рассмотренным ранее в разделе про выбор области. Значит, пока вы не уверены в своих действиях, лучше осевую скопировать, и именно этот вариант действий мы будем рассматривать далее.

Итак, мы решились на рисование направляющих в отдельном слое. Если мы его ещё не создали, сделаем это ({% action "NewLayer" %}*File > New Layer*{% endaction %}). После этого мы можем переключаться между слоями в окне справа-сверху. Там же мы можем дать слоям названия, чтобы не перепутать их. Переключимся на слой с осевой, кликнув по {% dialog "LayerList" %}панели слоев{% enddialog %} в столбце с галочкой в зелёном круге и строке с исходным слоем, или с помощью Shift+\[ / Shift+\]. Выделим осевую, чтобы скопировать её на наш новый слой. Копирование легче всего сделать, применив операцию {% action "MergeSelection" %}*Edit > Merge selection*{% endaction %}. После этого во всплывающем окне нужно выбрать слой, в который совершается копирование. Тут нам и пригодится название слоя, если мы его задали.

{% TODO %}скриншот: окно слоёв. Здесь видны названия слоёв "Layer 1", "Layer 2" и т.д., которые josm даёт по-умолчанию. - перенести выше{% endTODO %}

Вместо Merge selection можно использовать и обычное копирование через буфер обмена. Тогда после выделения осевой мы нажмём привычное Ctrl-C, переключимся через окно слоёв на слой для направляющих, и дальше нам захочется нажать на Ctrl-V. Как мы уже знаем из нашей первой попытки работать со слоями для рисования области выделения, обычная вставка через Ctrl-V не сохраняет абсолютные координаты копируемых объектов. Содержимое буфера обмена будет вставлено под мышиный курсор, что имеет смысл при копировании внутри одного слоя, но чего мы можем не ожидать при копировании между разными слоями. Мы можем решить, что подобная вставка нас устраивает, так как от осевой нам нужно только направление. Но это будет неудобно, если осевая достаточно длинная и состоит из ненужных для нашего квартала отрезков с другим направлением, которые можно перепутать, или если в качестве направляющей мы специально хотим использовать ломаную.[^9-broken] Также мы можем запомнить или ограничить определённым шагом расстояние от осевой до направляющей. По этим причинам удобнее, чтобы осевая в слое для направляющих оказалась на своём исходном месте. Это можно получить, используя {% action "PasteAtSourcePosition" %}*Edit > Paste at source position*{% endaction %} вместо обычной команды вставки.

[^9-broken]: Разница между этим и прямой не слишком существенна. Это также рассматривалось в [главе про выбор области сдвига](../5-area/). Далее мы будем считать, что направляющая всё-таки прямая.

После копирования осевой мы переключимся в слой для направляющих. Там мы первым делом удалим все теги с осевой, если они на ней есть. Легче всего это сделать так: выделить все элементы в слое (Ctrl-A), переключиться на окно тегов, кликнув по нему, выделить все теги (тоже Ctrl-A) и удалить их. Выделять все элементы надо, так как теги могут быть и на точках. Далее придадим осевой нужную форму. Если нам повезло, то форма осевой нас и так устраивает, но чаще всего нам нужен только определённый её участок. С обеих сторон от нужного участка могут быть остальные ненужные нам части линии, например, продолжения улицы вдоль других кварталов. От них можно отделаться, удалив их точки. Если ненужные части осевой достаточно длинные, легче её разрезать (P) по крайней точке нужного участка, возможно, предварительно поставив эту точку, и удалить лишнюю линию. Перед таким удалением во избежание появления неожиданных точек, важно было отделаться от тегов, как было указано в разделе про выбор области. Также внутри нужного участка могут находиться лишние точки, например, переходы через улицу. Их следует просто удалить.

Теперь у нас есть линия, целиком идущая в нужном нам направлении, от которой мы отрезали всё лишнее. Но, возможно, нам ещё нужно сделать противоположную операцию. Линия может быть короче квартала, потому что только такой короткий участок в исходной линии имел нужное нам направление. Нам нужно, чтобы будучи сдвинутыми к краю квартала, осевые, ставшие направляющими, пересекались на его углах. Для этого удобнее всего продлить осевую, сделав её немного длиннее квартала. Это можно было бы сделать, передвинув соответствующим образом концы линии, только, перетаскивая их вручную, мы испортим направление осевой. Чтобы продлить линию в том же направлении, у нас есть пара способов, использующих хитрые режимы josm.

Первый способ - пририсовать к линии ещё один отрезок, чтобы в итоге линия стала нужной длины. Обычно отрезок пририсовывается так: выделяется точка-конец линии, включается режим рисования (A), после чего josm догадывается, какую линию и с какой стороны следует дорисовать, дальше кликается нужное место, в результате чего линия продлевается до него. Ясно, что нас этот способ не устраивает, так как точно по нужному месту кликнуть мы не сможем, и линия продлится не совсем в нужном направлении. Эта неприятность устраняется использованием не обычного режима рисования, а {% action "Draw/AngleSnap" %}режима с ограничением углов{% endaction %} (AA). Для перехода в него, находясь в обычном режиме рисования, следует ещё раз нажать на A. После этого под окном редактирования подсветится зелёным {% help "StatusBar" %}иконка с углом в статусбаре{% endhelp %}. Направление продолжения линии теперь будет ограничено углами, кратными 45°, и мы сможем без труда продлить линию под нужным нам развёрнутым углом в 180°. После такой дорисовки в линии останется лишняя точка бывшего её конца, которую можно удалить.

Второй способ - перетаскивание точки конца с сохранением направления линии. Выполнять его мы будем не из того режима, который обычно используется для перемещения элементов, то есть режима S. Теперь нам нужен совсем другой режим - {% action "Extrude" %}режим выдавливания{% endaction %} (X). В этом режиме можно работать не только с отрезками, но и с точками. Для точек предусмотрена возможность их перемещения по направлению содержащих их отрезков, что нам и нужно. Совершить такое перемещение можно, удерживая Ctrl. Значит, нам нужно перейти в режим выдавливания, нажать и держать Ctrl, и потащить точку-конец осевой в направлении, удлиняющем наш слишком короткий отрезок. По сравнению с первым способом у нас уже не будет лишней точки, которую придётся удалять.

Кстати, у режима выдавливания есть ещё один подрежим, который нас в данный момент не интересует, но он мог бы нам пригодиться при рисовании рамки из направляющих одной замкнутой линией или при редактировании прочих "рамок" типа границы области выбора и landuse. Это режим выдавливания по двум сторонам. Как именно он может пригодиться, читатели догадаются самостоятельно, когда попытаются им воспользоваться. Включается этот режим повторным нажатием на X в режиме выдавливания, подобно тому, как это делается для лассо (повторное S) и только что рассмотренного рисования с ограничением углов (повторное A). При этом отображается переход в эти подрежимы по-разному: для SS это своя кнопка на боковом тулбаре, для AA - подсветка угломера внизу, для XX - надпись в статусбаре в правом нижнем углу. Хорошо, что несмотря на такой беспорядок, эти режимы в josm есть. В большинстве редакторов этого беспорядка не будет в связи с отсутствием соответствующих возможностей.

Теперь у нас есть осевая линия подходящей длины. Мы, наконец, готовы воспользоваться режимом параллельных линий (Shift-P), чтобы нарисовать направляющую. Начнём в этом режиме перетаскивать осевую линию по направлению к краю квартала. Сразу в начале перетаскивания будет создана ещё одна линия, которая собственно и перетаскивается. Эта линия и станет направляющей, когда мы закончим перетаскивание в нужном нам месте. Согласно приведённым ранее рассуждениям, нужное место - это, скорее всего, граница зданий. Насколько хорошо она видна на снимке, по которому мы ориентируемся, зависит от того, что это за снимок. На снимке может быть не видно нужного нам места из-за низкого разрешения, облаков, или просто потому что он слишком старый, и на нём нет новых построек. В таких случаях мы направляющую проводим, скорее всего, не по зданиям, так что пока предположим, что таких проблем у нас нет. Если они есть на одном снимке, возможно, доступен другой, уже без них.

Снимки без таких проблем можно поделить в зависимости от угла, под которым они сделаны:

1. под прямым углом, или составленные и обработанные чтобы так казалось, обычно делаются с коптеров;
2. почти под прямым углом, так что можно не заметить разницы с предыдущим вариантом;
3. очевидно не под прямым углом.

Например, в июле 2019 года для Санкт-Петербурга к первому виду можно отнести [снимки участника Sergey Astakhov](https://map.openaerialmap.org/#/30.3,59.9,11/user/59f0957e31eff4000c3804f4), ко второму - DigitalGlobe Premium, к третьему - [Bing](https://wiki.openstreetmap.org/wiki/Bing_Maps#Aerial_imagery). Стоило мне написать предыдущее предложение, как снимки DigitalGlobe Premium убрали, заменив их на то, что относится к третьему типу.[^9-maxar] В связи с этим хочется обратить внимание на то, что в данной записи рассматриваются *технические* причины использовать те или иные снимки. Помимо технических причин бывают причины *юридические*, которые говорят нам не слишком полагаться на те данные, которые правообладатель может в любой момент убрать.

[^9-maxar]: А потом убрали и то, чем заменили.

### Очевидно непрямоугольные снимки

Третий тип - либо самый удобный для нашей задачи, либо самый неудобный. Если на снимке видны нужные нам стороны зданий, то видна и линия их пересечения с землёй, по которой должна идти направляющая. Тогда нам достаточно перетащить линию до этого места, и дело сделано. На самом деле оно, конечно, не сделано, потому что нам нужна направляющая и с противоположной стороны квартала, с которой нужные стороны зданий уже видны не будут. Получается, что с точки зрения рисования не одной, а всех направляющих, такой снимок полностью удобным не является.

Как и любую неприятность со снимком, мы можем попытаться решить эту, взяв другой снимок. Может быть, другой снимок относится к первому или второму типу, и тогда по нему можно с меньшим количеством проблем провести все направляющие. Но нередко бывает, что все доступные снимки относятся к третьему типу. Тогда нам может прийти мысль совместить разные снимки, сделанные под разными углами, с которых видны разные стороны зданий. У реализации этой идеи есть две проблемы. Во-первых, углы, скорее всего, недостаточно разные. Например, для Санкт-Петербурга снимки в направлении с севера на юг встречаются реже прочих, так что одной из сторон зданий, скорее всего, не будет ни на одном из снимков.

Второй проблемой будет то, что разные снимки нужно совместить. Её, вроде бы, быть не должно, потому что мы подразумеваем, что правильное смещение снимков уже установлено. Однако совсем правильным ему быть не обязательно, и такого даже не может быть. Смещению снимков достаточно быть более правильным, чем смещению уже введённых данных квартала, которые мы хотим подвинуть. Также смещению снимков нужно быть правильным в пределах интересующей нас точности. Если нас интересует точность в 1 метр, то два снимка могут расходиться на 2 метра, а это нас уже может не устраивать. К тому же, к относительной точности у нас более высокие требования. Нас может устраивать, когда все стороны объекта сдвинуты одинаково, но не устраивать, когда они сдвинуты по-разному из-за того, что рисовались по разным снимкам. Лучше всего будет подогнать все используемые снимки под осевые, если осевые соответствуют чему-либо видимому на них. Если имеющиеся в нашем распоряжении осевые линии ничему не соответствуют, возможно, их стоит перерисовать.

Если совмещать разные снимки мы не собираемся или толку от этого не предвидится, то что мы можем сделать для направляющей с "невидимой" стороны? Если здания вдоль неё достаточно длинные, то, как минимум, мы можем проверить её *направление*. Перетащим линию к видимому на снимке краю здания, который будет краем крыши и посмотрим, достаточно ли хорошо они совпадают. Если здания вдоль стороны квартала одинаковой высоты, сравнивать линию можно со всеми ними сразу. Если нам уже в этот момент стало ясно, что направление не подходит, придётся переходить к следующему способу.

Допустим, *направление* направляющей нас устраивает, тогда остаётся выбрать *смещение*. Самый простой вариант это сделать - совместить направляющую с чем-то ещё, находящимся на уровне земли и на одной линии со зданиями. Для этого это что-то должно на линии существовать. Как мы уже знаем, удобными ориентирами для установки линии могут быть заборы, которые часто идут по ней с точностью в пару дециметров. Преимуществом заборов по сравнению со зданиями является то, что они примерно плоские, что позволяет смотреть на них как с одной, так и с другой стороны, и видеть ту же самую линию по их основанию. Значит, при разглядывании заборов у нас не будет проблем с тем, что видны их внутренние стороны, а не внешние, выходящие на улицу.

Доставить проблемы могут тени от заборов, которые мы можем перепутать с самими заборами, так что надо сразу сообразить, видны ли они на снимке. Для узких объектов тень может быть заметнее самих этих объектов. Впрочем, у заборов в городской среде могут быть достаточно широкие опоры с металлическими верхушками, которые хорошо видны на снимке. Верхушки - это конечно не совсем то место, где нам нужно провести направляющую, зато они позволяют отличить тень забора от самого забора. Но даже если верхушки забора использовать как ориентир вместо его основания, проблем это создаст меньше, чем аналогичное использование края крыши у здания. Заборы обычно достаточно низкие, чтобы их верх на снимке не был слишком далеко сдвинут относительно их низа.

{% TODO %}фотка: Городской забор, левая часть которого подойдёт для установки смещения линии. Как видно, она достаточно короткая, чтобы направление линии по ней было не определить.{% endTODO %}

Итого, с заборами вероятная последовательность действий будет такой: замечаем тень от забора; соображаем, что отбрасывает тень; приглядываемся с снимку повнимательнее; находим на нём сам забор; перемещаем линию так, чтобы она совпадала с его основанием, если оно видно, или совпадала хоть как нибудь, если основания не разглядеть. Самому забору при этом не обязательно быть достаточно длинным, так как для определения направления линии он не используется. Также забору не обязательно присутствовать в уже введённых данных, там нам нужны лишь здания, вместо края которых мы наблюдаем на снимке забор. Если забор или другой подобный ориентир нам в данных нужен, мы можем нарисовать его после того, как выполним сдвиг квартала.

Помимо забора в качестве подходящего ориентира мы упоминали газон. Тут нам уже не помешает тень от газона, зато сам газон может оказаться в тени от зданий. В тени он будет менее заметен, чем забор. Ещё на нём могут расти деревья, которые закрывают листвой его край. Впрочем, деревья бывают и близко к заборам, так как за заборами бывают сады, значит, аналогичная проблема может встретиться и с заборами. Снимки часто делаются летом, так что листвы на них бывает достаточно. При наличии мешающих деревьев лучше подойдут осенние снимки с уже опавшей листвой, хотя на них будут более длинные тени.

Если подходящих ориентиров помимо зданий в квартале нет, нам остаётся либо всё-таки пользоваться зданиями, либо устанавливать направляющую для одного квартала по другому. Если рассчитывать только на здания квартала, можно попытаться воспользоваться тем, что на *невидимой* стороне на уровне земли будет виден угол одного из угловых зданий квартала. Виден он будет, правда, плохо, то есть из двух образующих его стен будет видна только одна. Это ещё не самая большая неприятность, потому что две стены его могут не вполне образовывать: угол может быть срезан или скруглён. Без этого нам было бы достаточно найти одну точку, на которой контур здания поворачивает и переходит из скрытого зданием в нескрытый. А так поворот растягивается в пространстве, и его крайняя видимая точка уже может не являться точкой его соединения с прямой, которую мы ищем.

{% TODO %}схема, где точку не видно на скруглённом углу{% endTODO %}

На углу здания в качестве дополнительного препятствия может присутствовать вход с крыльцом и козырьком, ухудшающий обзор стены. Но даже без этого и без скруглений, целиться по одной точке нам будет сложнее, чем по отрезку. Такой проблемы не было бы при идеально чётком изображении с достаточно высоким разрешением, но, когда речь идёт о снимках рассматриваемого типа, с разрешением дело обстоит не очень. С другой стороны, если и приходится ориентироваться по размытым точкам, может обнаружиться возможность использовать их несколько штук для одной направляющей линии. Если между зданиями есть достаточно большие промежутки, через них может открываться вид на дополнительные углы зданий, находящиеся на искомой линии. Углы посередине квартала реже бывают срезаны, что облегчит нашу задачу. Конечно, мы бы предпочли промежуток, перекрытый забором, но и без забора промежуток даёт нам преимущества с *невидимой* стороны квартала. С *видимой* же стороны промежуток без забора, особенно длинный, нашу задачу не облегчит, так как ориентиров из-за него станет меньше.

Если нам не хочется ориентироваться по одной не слишком хорошо видной точке, можно попытаться воспользоваться изображениями других кварталов. Это будет частичным или даже полным воспроизведением шагов метода перерисовки осей, так что в данном разделе мы подробно их описывать не будем. Здесь мы только отметим пару возможных путей. Можно воспользоваться ориентирами другого квартала, располагающимися на той же линии, где мы хотим видеть направляющую. Для этого улица на рассматриваемом участке должна быть прямая и постоянной ширины. В прямоте улицы, кстати, надо ещё убедиться, но это обычно легко сделать либо на месте, либо даже по уличным панорамам. Наши шансы провести направляющую, впрочем, не слишком велики, потому что на снимке рассматриваемого типа мы будем по прежнему смотреть на *невидимую* сторону. Но нам может повезти, если на линии по краю другого квартала обнаружится заборчик или что-нибудь подобное, чего мы не нашли у нашего квартала.

Из *невидимой* в *видимую* сторона улицы может перейти, если улица поворачивает. Тогда край квартала уже не будет на одной линии с нашей направляющей, но если ширина улицы сохраняется, мы можем эту неприятность обойти. Для этого нам надо вспомнить, что существенная часть сказанного про осевые, направляющие и прочие линии типа тротуаров применима не только к прямым. В частности, режим параллельных линий работает и с ломаными. Однако, трудностей в случае непрямой улицы у нас добавится. Постоянство ширины у неё проверить будет сложнее. Кроме того, если раньше нам было не важно, идёт ли осевая на самом деле по середине улицы, а важно было лишь её направление, то теперь это требование становится важнее. То есть, у нас станет меньше шансов взять одну из линий *двухвейки* в качестве осевой.

Если осевая идёт точно по середине улицы, и эта середина является серединой расстояния между зданиями на противоположных сторонах улицы, у нас появляется дополнительная возможность. Вместо квартала далее по улице, мы можем использовать как ориентир квартал напротив. Его сторона, выходящая на ту же улицу, на снимке будет уже *видимой*. Тут мы снова используем режим параллельных линий как линейку, чтобы измерить расстояние до края видимой стороны. Далее мы нарисуем параллельную линию уже с *невидимой* стороны на измеренном расстоянии. Проверить, насколько результат этого близок к реальности мы можем, попытавшись найти на ней углы зданий или оценив ширину тротуара, если хотя бы часть его видна.

Последнее, что мы скажем про данный тип снимков - это то, что приведённые выше рассуждения касались мест с достаточно плоским рельефом. Что делать с кварталом, расположенным, например, на склоне холма, я могу только теоретически порассуждать, так как мне с ними дело иметь не приходилось. Ясно, что направление линии основания здания, так удобной для нас в плоских местах, уже не будет подходить для направляющей. Пока что мы считаем, что направление нам уже известно из осевой, но в такой ситуации мы не сможем по основанию определить и смещение. Если мы знаем, что осевая проходит действительно по середине улицы, и для неё там есть ориентир, например, дорожная разметка, мы можем сдвигать снимок так, чтобы видимая на нём середина улицы совпадала с осевой. Таким образом мы можем поступить в нескольких местах на протяжении квартала, для каждого из которых мы оценим, насколько хорошо нарисованная нами направляющая совпадает с основанием зданий. Для невидимой стороны и непрямой улицы проблем у нас будет больше, да и уверенности в точности самой осевой нам может недоставать без простого способа её проверить. Лучше всего, конечно, раздобыть более подходящие снимки, такие как рассматриваемые далее.

### Почти и совсем прямоугольные снимки

Перейдём к снимкам второго типа, которые сделаны почти под прямым углом. Что значит "почти" и зачем их понадобилось выделять в отдельный тип? "Почти" значит то, что отклонения направления снимка от вертикального можно не заметить, но оно есть. Для многих задач на него можно было бы не обращать внимание, однако смещение крыши здания при нём может быть сопоставимым с шириной тротуара. Поскольку рисование тротуара или того, что на нём находится, могло служить причиной выполнения сдвига, обратить внимание на такое отклонение нам придётся.

Несмотря на то, что крыши смещены, самих оснований зданий на таких снимках толком не видно, так что *все* стороны квартала становятся в некоторой степени *невидимыми*. Если пойти по самому простому пути, то есть провести направляющие по хорошо видным краям крыш, получившаяся в результате рамка вокруг квартала будет смещённой и более широкой, чем она должна была бы быть. Разница в ширине возникнет от того, что крыша шире самого здания. Шире она может быть в разной степени и само по себе это больших проблем бы не создало, но с учётом её смещения и нечёткости снимка, рамка из направляющих может перекрыть чуть ли не весь тротуар. Такое развитие событий нас вряд ли устраивает. С другой стороны, этот простой путь у нас есть, а для снимков третьего типа его не было. Если квартал очень сильно смещён, а тротуары рисовать мы не собираемся, этого пути нам может оказаться достаточно. Правда, мы скорее пойдём по его ручному варианту, то есть сдвинем квартал, ориентируясь по крышам, без рисования направляющих и запуска скриптов. Направляющие нам понадобятся, если у квартала вдобавок искажены форма или размер, что тоже вероятно.

Даже при серьёзных расхождениях изображения края крыши и искомого места направляющей с некоторых сторон квартала, с некоторых других сторон выбор места по крыше может нас устраивать. Мы можем даже на глаз сместить направляющую относительно края крыши в направлении, противоположном сдвигу крыши. Направление мы можем оценить, посмотрев на тротуары вокруг квартала. Дальнейшие уточнения мы оставим на потом. Нам надо, чтобы расстояние, на которое понадобится перемещать стены зданий при отложенных уточнениях, было достаточно небольшим, и ещё один сдвиг всего квартала был бы не нужен.

Что мы можем сделать для тех сторон, где нас не устраивает подвинуть направляющую, глядя лишь на крыши? Первое, что мы сделаем - это поищем ориентир типа забора. Для такого типа снимков наши шансы его найти повышаются, потому что он уже не может быть закрыт зданиями. Если в этом мы не преуспеем, мы можем поискать ориентир в соседних кварталах, как это было вкратце описано для предыдущего типа снимков. Помимо этого, нам почти наверняка виден внешний край тротуара, так что мы можем отложить определённое расстояние от него. Это действие тоже будет частичным воспроизведением перерисовки осей.

В целом, если доступен только один снимок, можно сказать, что второй тип создаст нам меньше проблем, чем третий. Однако, чёткой границы между этими типами нет, и тип мы рассматриваем только применительно к определённому месту. При увеличении высоты зданий второй тип переходит в третий. Значит, если вы привыкли действовать по снимку определённым образом, вам надо быть готовым этот образ поменять. То есть, не получится решить, что раз на этом снимке вести линии по краям изображений крыш подходит в одном месте, то обязательно подойдёт и в другом.

Теперь перейдём к первому типу. Такие снимки часто делаются с коптеров, и некоторые их особенности рассматривались в самом начале записи. У этих снимков бывает достаточно высокое разрешение, чтобы у участников создавалось впечатление, что по ним можно всё точно нарисовать. Впечатление это, как мы уже знаем, верно лишь отчасти. На снимках такого типа, как и на предыдущих, видны края крыши или другие выступающие за плоскость фасада элементы, а сама плоскость фасада не видна. Зато крыша и всё прочее уже не смещено относительно основания, и изображение всего гораздо более чёткое. Значит, если вы рисуете с точностью до метра, можете смело проводить направляющие по краям изображений зданий.

Проблемы могут возникнуть, если рискнуть нарисовать края зданий с ещё большей точностью. Тогда мы можем решить, что здания не расположены на одной линии, потому что так нам видно на снимке. По уже не раз упомянутым причинам мы можем ошибаться, но даже если мы и правы, надо вспомнить, что в данный момент мы ещё не рисуем детали зданий. Сейчас мы выбираем место для направляющей линии, которая послужит вспомогательным средством для перемещения квартала. Её не имеет смысла проводить намного точнее, чем уже нарисован сам квартал. Если вы видите на более точном снимке данного типа отклонения линии фасада в дециметр, которых вы не заметили бы на менее чётких снимках, вам следует не заметить их и сейчас. Если эти отклонения вам нужны, вы их сможете нарисовать потом, после перемещения квартала.

Точность выше метра, если мы рискнём её воспроизводить, приведёт к необходимости изменить некоторые действия. Сам режим проведения параллельных линий, в котором мы устанавливаем направляющую, не годится для точности выше метра при обычном использовании. Как мы знаем, линия в этом режиме перемещается не свободно, а по полуметровым шагам. При этом ограничении легче воспроизвести рисование параллельной линии на таком же расстоянии в другом месте. Чтобы от ограничения отказаться, при перетаскивании параллельной линии надо {% action "Parallel#Modifiers" %}удерживать Ctrl{% endaction %}.

Дальше, если мы видим по-разному торчащие края крыш, у нас возникнет вопрос, куда именно ставить направляющую. Ориентироваться придётся по той крыше, которая торчит менее всего, так как её край должен быть ближе к фасаду. Как и при предыдущих типах снимков, мы можем попытаться воспользоваться и другим ориентиром. Раньше для этого нам был удобен забор, идущий по краю квартала. Теперь нам надо учитывать ранее незначительную разницу между линией забора и линией фасада. То же самое может оказаться верным и для любого другого ориентира. В общем, на данном этапе от выставления направляющей с такой точностью толка будет мало, а проблем добавится. Если же нам удастся не обращать внимания на слишком высокое разрешение и не пытаться его воспроизводить в рисуемых линиях, снимки такого типа будут наиболее удобны для нашей задачи.

### Направление и смещение по снимку

В данный момент мы находимся в процессе перетаскивания копии осевой линии и видим конкретное место на снимке, куда её надо установить. Если нам повезло или мы должным образом подготовились к этому заранее, нам остаётся лишь завершить перетаскивание в данном месте, тогда процесс рисования направляющей завершён. Но нам может и не повезти: обнаружится, что направление выбранной нами осевой линии не совпадает с направлением целевой линии на снимке. Увидим мы это, потому что нам просто не удастся поместить копию осевой на желаемое место в режиме параллельных линий. Тогда нам придётся полностью самостоятельно рисовать линию, то есть выбирать по снимку не только её *смещение*, но и *направление*.

Мы могли бы перерисовать осевую линию, а также заодно все совпадающие с ней по направлению линии, что было бы тем самым способом, рассмотрение которого мы отложили до другой записи. Другой способ действий, который и рассматривается в данном разделе, - нарисовать непосредственно направляющую, не пользуясь осевой. Делать это мы будем в обычном режиме рисования (A), режим параллельных линий нам не понадобится.

При рисовании мы воспользуемся следующим соображением: чем длиннее рисуемая по снимку прямая, тем точнее мы сможем передать её направление. Помешать нам могут искажения на снимке, когда изображение "уплывает" в сторону. Предположим, что таких искажений нет. Также не выйдет нарисовать прямую, если искомая линия на самом деле не прямая. Это мы заметим в процессе рисования. Пока что мы надеемся увидеть именно прямую, причём сразу наибольший возможный её отрезок. Для этого сделаем так, чтобы в окне редактирования оказалась видна целиком вся сторона квартала, вдоль которой мы хотим провести направляющую. Тут нам может прийти идея смотреть на сразу несколько последовательно идущих кварталов, в случае, если здания в них идут по одной линии. Идея эта правильная, но мы её оставим для метода перерисовки осей, при котором мы будем пытаться получить более точный результат, здесь же мы ограничимся одним кварталом.

Увидим ли мы в принципе место для проведения направляющей зависит, как и раньше, от типа и качества снимка. Одной из причин пробовать рисовать направляющую сначала как производную от уже имеющейся осевой как раз и было то, что так получилось бы меньше ошибок. В идеальной ситуации ошибок с направлением бы не было, а такие ошибки более неприятны, чем ошибки смещения. Осевая линия рисуется по более видному на снимках месту, а место направляющей может быть непосредственно не видно, особенно если направление снимка сильно отличается от вертикального. Тогда, посмотрев на снимок, мы можем решить, что проще всё-таки перерисовать осевую, параллельно которой потом можно будет провести направляющую.

Допустим, что нашему решению непосредственно рисовать направляющую ничто не помешало, и мы смотрим на сторону квартала, видную целиком в окне редактирования. Тогда, в качестве первого приближения направляющей, мы проведём отрезок, соединяющий две точки. Отрезок должен проходить по месту направляющей линии, но достаточно точно мы его провести не можем из-за выбранного нами масштаба данных в окне редактирования. Точки-концы отрезка мы поставим так, чтобы они находились за пределами квартала, что нам нужно согласно причинам, указанным выше при укорачивании/удлинении осевой. После того, как первая версия отрезка проведена, мы будем уточнять его, двигая это точки отдельно. Приблизимся к одному концу, подвинем его так, чтобы отрезок лучше совпадал с желаемым местом направляющей, приблизимся к противоположному концу, сделаем то же самое. Будем повторять чередующиеся перемещения двух точек, пока не достигнем удовлетворительного результата.

Собственно удовлетворительного результата мы таким путём не сможем достичь, если здания на самом деле не идут вдоль одной прямой. Сейчас мы не имеем в виду отдельные выступающие вперёд или назад части зданий или даже все здания. К этому моменту мы уже решили, на какие из них не следует обращать внимания. Нас интересует, не меняется ли направление идущих вдоль улицы стен зданий или прочих объектов, выбранных нами в качестве границ квартала. Если это так, это могло послужить причиной того, что нам не удалось провести направляющую параллельно осевой, даже при наличии правильной осевой. Выяснять, так ли это, нам придётся, если мы будем видеть отклонение проведённого нами отрезка прямой от желаемого места направляющей даже после установки его концов наилучшим образом.

Если отклонение видно на снимке, надо сначала выяснить, существует ли оно на самом деле. Иногда всё довольно очевидно, так как сразу обнаруживается, что линия границы квартала резко загибается градусов на тридцать. В этом случае мы сразу поймём, что рисовать направляющую одним прямым отрезком бесполезно. Но бывают и гораздо меньшие отклонения, на которые мы раньше не обращали внимания. Реальные ли они или кажущиеся, мы можем выяснить по осмотру на местности или по снимкам с уровня земли типа панорам улиц. Отрезок подлиннее мы и пытались провести для того, чтобы усреднить кажущиеся отклонения, такие как погрешности снимка, и обнаружить неизвестные нам ранее реальные.

Если реальных отклонений нет, то дело рисования направляющей сделано. Если они есть, то надо оценить, нельзя ли представить границу квартала в виде ломаной линии. Если да, то мы могли бы уточнить нарисованную нами линию, добавив в неё точки, но лучше поступить по-другому. Большей точности мы добьёмся, нарисовав каждый из отрезков ломаной отдельно, таким же способом, каким мы рисовали один отрезок вдоль всей стороны квартала. Это будет рисование нескольких отрезков, более длинных по сравнению с соответствующими отрезками будущей ломаной. Большая длина нужна для того, чтобы соседние отрезки пересекались подобно направляющим линиям с разных сторон угла квартала. Прежде чем эти пересечения зафиксировать установкой в них точек, мы проделаем для каждого отрезка независимое от остальных уточнение положения его концов с помощью перетаскивания их точек. После этого построение ломаной можно закончить, поставив точки пересечения отрезков, удалив лишне "торчащие" точки и объединив отрезки в одну линию.

Если отрезков много, а мы хотим ограничиться только сдвигом квартала без последующего выравнивания его сторон, то мы можем упростить операцию. Для сдвига нам в конечном итоге нужны точки на углах сдвигаемой области, которые мы получаем пересечением направляющих. Значит, нам достаточно нарисовать только те части направляющей, которые пересекутся с другими направляющими. Для направляющей в виде ломаной этими частями будут её первый и последний отрезки, то есть те отрезки, которые проходят через углы квартала. Конечно, при этом мы кое-чем жертвуем, например тем, что мы не указываем с помощью отрезков направления, вдоль которых искажения должны быть минимальны. С другой стороны, в этой записи мы и не рассматриваем, как использовать более четырёх направляющих точек и, соответственно, отрезков.

{% TODO %}проверить режим уточнения{% endTODO %}

Форма края квартала может оказаться и сложнее. Следующей формой, которую имеет смысл проверить, будет ломаная со скруглёнными соединениями отрезков. Мы уже знаем об одном распространённом скруглении - скруглении угла квартала, но на него мы пока не обращаем внимания. Теоретически мы могли бы объединить две подходящие к углу направляющие линии в одну и скруглить угол у полученной одной направляющей, но это не соответствует нашей задаче получения там единой угловой точки. В результате скругления получилось бы несколько соединённых отрезками точек, как на углу квартала, так и в другом месте его границы. Так что скругления для линий, которые мы собираемся использовать в качестве направляющих *для сдвига квартала*, нам не нужны в любом случае.

Вместо направляющей со скруглениями мы можем нарисовать вдоль стороны квартала такую ломаную линию, которая при добавлении должных скруглений стала бы соответствовать наблюдаемой форме стороны. Сами же скругления мы можем сделать уже после сдвига, если они будут нам нужны *для последующих поправок-выравниваний сторон квартала*. Если такими поправками мы заниматься не планируем, то и скругления нам делать не понадобится. И, конечно, мы можем упростить задачу и дальше, как для случая, когда отрезков у стороны много, нарисовав лишь два крайних из них.

Форма стороны квартала может быть и ещё сложнее. Тогда нам придётся бросить попытки рисования одной направляющей линии, так как теряется их смысл. Смысл был в том, чтобы подогнать линию регулярной формы под воспринимаемую нами геометрию исходя из того, что объекты проектировались и строились так, чтобы их форма была регулярная. При этом у нас имелись основания полагать, что отклонения от регулярной формы являлись скорее нашими ошибками, чем реальностью, а если и не ошибками, то отказами от оправданных упрощений. Если же никакой регулярной формы мы обнаружить не можем, то пропадает разница между ошибками рисования нерегулярной направляющей и отклонениями объектов от этой направляющей. Последнее, что мы можем сделать это попытаться найти прямые участки стен рядом с углами квартала для обоих угловых зданий с рассматриваемой стороны квартала и нарисовать два отдельных направляющих отрезка. Если это нам не удастся, придётся обходиться без направляющей.

## Установка контрольных точек

Если всё прошло по плану, у нас по сторонам квартала нарисованы направляющие линии, которые пересекаются друг с другом на его углах. Если всё пошло менее по плану, то целиком направляющих нет, но есть их отрезки, доходящие до углов. Если нам не повезло, направляющих у нас нет, ни целиком, ни частично. Наша текущая задача - получить для каждого угла по паре точек, далее называемых *контрольными*. Одна из точек будет *исходной*, расположена она будет относительно уже введённых и ещё не передвинутых данных, в самом простом случае она уже есть в данных. Другая точка *целевая*, в которую переместится исходная, находиться она будет в том месте, которое мы посчитали настоящим положением угла квартала, там, где пересекаются направляющие. Под получением контрольной точки подразумевается либо обнаружение в данных осмовского элемента-точки, либо добавление туда временного элемента.

### Исходные точки

В самом простом случае исходная точка уже имеется в данных. Если на углу квартала находится здание, у которого не срезан угол, то точка на углу здания и является искомой. Вместо здания на углу квартала может быть и другой объект, по сторонам реального расположения которого мы посчитали возможным провести направляющие. Тогда нам подойдёт угловая точка соответствующего ему элемента данных, если угол его, опять же, не срезан.

Первой сложностью, которую мы рассмотрим, будет ситуация, когда объект на углу квартала есть, но угол у него срезан. Далее мы будем считать, что этим объектом является здание, операции для других видов объектов аналогичны. У зданий углы часто срезаются, чтобы расположить там вход. Мы же хотим получить такую точку, на которой располагался бы угол здания, если бы он срезан не был. Это та точка, в которой пересекаются прямые, на которых расположены участки стен здания вдоль двух сторон квартала. В уже введённых данных этих прямых нет, и нет таких отрезков на этих прямых, которые бы доходили до искомой точки. Зато понятно, что их несложно достроить, то есть продлить прямые стороны здания до нашей цели.

Стандартными средствами josm продлить стороны здания до искомой точки можно, пририсовав к зданию с двух сторон две линии в режиме рисования с ограничением угла (AA). У нас есть два варианта, относительно чего угол ограничивать: относительно рисуемой линии или относительно уже имеющейся в данных. В первом варианте, чтобы нам пригодилось ограничение угла, мы станем рисовать каждую из двух линий так, чтобы её начало шло поверх прямого участка стены. В качестве первой точки линии выберем уже существующую на прямом участке точку подальше от угла. Второй точкой сделаем ту точку прямого участка, которая ближе всего находится к углу. Эту и подобные ей точки, которых будет по две для каждого срезанного угла, мы будем называть *предугловыми*. Далее продолжим рисовать линию в направлении искомой точки, а точнее - немного дальше её, так как линия должна пересечься с аналогичной линией по другой стороне квартала. Обе рисуемые нами линии должны быть прямыми, чего нам будет легко добиться благодаря ограничению угла между отрезками. В результате каждая линия будет состоять из двух отрезков: первого, перекрывающегося со стеной, нужного для ограничения направления второго отрезка, и второго, являющегося продолжением стены за пределы здания.

Мы можем решить, что рисуемые описанным выше способом временные линии неудобны тем, что их части проходят поверх уже существующей линии. Эта уже существующая линия, то есть контур здания, временной не является, и удалять её мы не собираемся. Позже мы можем добраться до её редактирования, которому проходящие поверх временные линии будут мешать. При рисовании временных линий было бы удобнее обойтись без перекрывающих существующую линию отрезков, чего можно добиться, начав рисовать линии от предугловых точек. Тогда, чтобы рисовать каждую из линий в правильном направлении, нам потребуется сразу указать, относительно чего направление должно быть ограничено. При предыдущем способе это не требовалось, так как направление первого рисуемого отрезка задавалось двумя уже существующими точками, а направление следующего отрезка ограничивалось согласно предыдущему. Теперь, чтобы ограничить направление первого же рисуемого отрезка, надо, начав его рисование, навести курсор на прямой участок стены здания и нажать Ctrl. Дальше нам остаётся завершить рисование временной линии, которая теперь состоит из одного отрезка.

Получив любым из приведённых выше способов две линии, нам остаётся поставить точку на их пересечение. Эта точка и будет искомой исходной точкой. После получения исходной точки может возникнуть желание удалить временные линии, но надо обратить внимание на то, что после обычного их удаления исчезнет и исходная точка, так что удаление временных линий легче отложить до выполнения сдвига.

Помимо описанных выше способов получения временных линий можно придумать и другие. Например, желающие могли бы добиться аналогичного результата с помощью плагина AlignWays. Мы же рассмотрим более простой способ, требующий запуска скрипта для плагина CommandLine. Именно им и имеет смысл пользоваться, так как плагин CommandLine понадобится и для выполнения самого сдвига.

Получим временные линии, а вместе с ними сразу и исходную точку с помощью скрипта CornerRestore из [моего набора скриптов](https://github.com/AntonKhorev/JOSM-CommandLine-commands). Для использования CornerRestore надо выделить все необходимые элементы, а затем запустить скрипт. То есть, в качестве параметра скрипт принимает один набор элементов и сам определяет, какой из них выступает в какой роли. Так делается для того, чтобы повторный вызов скрипта, который наверняка понадобится, можно было выполнить одним выделением и последующим двойным нажатием на Enter. При двойном нажатии на Enter плагин CommandLine запускает предыдущий скрипт, все аргументы которому мы уже сообщили с помощью выделения.

Какие элементы необходимо выделить, чтобы передать их скрипту? Во-первых это линия контура здания, у которой срезан угол. Вместе с линией надо выделить и несколько точек, образующих срезанный угол. Это те точки, которых не было бы в контуре здания, если бы угол срезан не был, то есть две предугловые точки и все точки между ними. В самом простом случае, когда угол срезан по прямой, двумя предугловыми точками выделение и ограничивается. Если на срезанную часть были добавлены точки типа {% tag "entrance=*" %}, выделить нужно и их.

После выполнения скрипта к зданию будет пририсована линия в виде угла, который существовал бы, если бы он не был срезан. Сама линия для перемещения квартала нам не нужна, но по ней легче найти угловую точку, которая и выступит в качестве исходной точки. Линия также может пригодится, если мы решим, что угол был срезан криво, и захотим его перерисовать. Делать это надо будет уже после сдвига квартала, так что пока линию мы оставим.

Мы разобрались со случаями, когда на углу квартала было здание, по геометрии которого мы могли получить исходную контрольную точку. Теперь рассмотрим, что нам делать, если объекты, соответствующие направляющим линиям в данных есть, но на углу квартала нет уже нарисованного здания или другого подходящего объекта. В реальности такой объект может и существовать, и просто его ещё никто не добавил в осм. Мы его тоже не будем добавлять до тех пор, пока не выполним сдвиг. Если нам захочется, то нарисуем мы его по уже имеющимся у нас направляющим линиям, но сначала под эти линии надо подогнать квартал.

На самом деле, мы уже рассмотрели, что надо сделать. Надо найти точку пересечения двух временных линий, которые строятся как продолжения сторон зданий вдоль границы квартала. Выше, перед тем как сказать про скрипт CornerRestore мы уже объяснили, что можно сделать, чтобы продолжить стороны одного здания без использования данного скрипта. Теперь мы сделаем то же самое для двух разных зданий, и найдём точку пересечения продолжения их сторон, которая и будет исходной точкой сдвига квартала. Скрипт CornerRestore нам уже не поможет, так как он позволяет пририсовать угол к одной линии, а нам надо пририсовать его к двум.

Остаются случаи, когда в данных нет объектов, соответствующих направляющим, и, возможно, нет даже и самих направляющих. Как мы знаем, воспользоваться скриптом перемещения квартала нам это не помешает, но толку от такого действия станет заметно меньше. Если нам всё равно хочется использовать скрипт, нам придётся самостоятельно выбирать место для исходной точки. Место должно быть как-либо определяемым относительно уже введённых данных, а также должна быть возможность его найти относительно снимка с правильным смещением, чтобы поставить там целевую точку. Ставить исходную точку без соответствующей ей целевой точки не имеет смысла.

Ещё возможна промежуточная ситуация, когда для определённого угла квартала вдоль одной из сторон построить направляющую линию и временную линию для исходной точки можно, а вдоль другой - нельзя. Так как положения точек полностью определяются пересечением линий, а линия для каждой из контрольных точек есть только одна, в данной ситуации положения точек не определены. С другой стороны они ограничены тем, что находятся на заданных прямых, а не где угодно на плоскости. Если мы всё ещё хотим использовать рассматриваемый способ перемещения квартала, имеет смысл этим ограничением воспользоваться. Нам придётся самостоятельно выбирать места на линиях, и если мы это сделаем, то сможем избежать искажений направлений элементов квартала вдоль этих линий.

### Целевые точки

Если с рисованием направляющих мы успешно справились, поставить целевые точки в местах их пересечений совсем просто. Но направляющие мы рисовали на отдельном слое, а точки нам нужны на одном слое с перемещаемыми данными. Передать точки в качестве аргументов, переключаясь между разными слоями можно, но работать скрипт может только с одним слоем. Этот слой должен быть включен при исполнении скрипта, который произойдёт после передачи последнего аргумента, но последним аргументом будет точка со слоя направляющих. Значит, придётся переместить точки на слой с редактируемыми данными.

На самом деле, удобнее делать не так. Удобнее в слое с направляющими точки не ставить, скопировать направляющие в слой с кварталом с помощью merge selection и там уже на их пересечениях поставить точки. Так мы оставим экземпляр направляющих без связывающих их друг с другом точек. Эти линии нам могут ещё пригодиться, например, для выравнивания тротуара вдоль зданий. Также нам не понадобится копировать и затем запоминать место и назначение отдельных точек. Вместо этого мы их сможем с лёгкостью найти по гораздо более заметным копиям направляющих, и точки не затеряются среди других осмовских данных.

Описанные выше действия мы могли совершить, если нам ранее удалось построить направляющие или хотя-бы их пересекающиеся части. Если нам это не удалось, то про целевые точки можно сказать примерно то же самое, что было сказано в аналогичной ситуации про исходные.
