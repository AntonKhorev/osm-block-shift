---
title: Выбор области сдвига
---

Наша операция по сдвигу начинается с решения о том, что именно надо сдвигать. Мы, казалось бы, уже определились с областью сдвига: это квартал. Несмотря на это, у нас по прежнему может оставаться вопрос, где именно провести границу квартала. Насколько это существенный вопрос, зависит от того, что уже нарисовано. В самом простом случае на краю квартала нарисованы здания, и между ними и highway-линией улицы ничего больше нет. Тогда мы условно проведём границу области сдвига так, чтобы здания в неё вошли, а улица не вошла. Как провести границу реально, написано в [следующей главе](../6-select). Конечно, возможен и ещё более простой случай, когда не нарисованы даже и здания, но тогда нам незачем действовать согласно данной записи.

Что может быть уже отмечено между внешними зданиями и линией улицы? Всё, что угодно, что там есть или было, и что осмеры посчитали нужным к данному моменту ввести. В первую очередь это тротуар. Тротуары при их наличии могут быть обозначены отдельными линиями {% tag "footway=sidewalk" %} или тегами {% tag "sidewalk=*" %} на линиях улиц. В этой записи при рассмотрении тротуаров мы будем подразумевать отдельные линии по нескольким причинам. Во-первых, если тротуар не обозначен отдельной линией, у него нет отдельной геометрии в осмовских данных. Нам, интересующимся в настоящий момент преобразованиями геометрии, не понадобится такой тротуар рассматривать. Во-вторых, можно предположить, что при рассматриваемом уровне детализации рисование тротуаров отдельными линиями будет являться целью участников. Если у нас достаточно данных внутри квартала, которые мы не хотим испортить его перемещением, тротуар вокруг него нам уже не будет казаться лишним. Кроме того, внутри квартала, вероятно, будет достаточно проходов, каждый из которых не обязательно важнее тротуара. Для того, кто взялся их рисовать, логичным будет изобразить и тротуар, особенно если эти проходы с ним соединяются.

Мы начали эту запись с того, что представили себе осмера, вводящего подобные объекты между зданиями и улицами, и обнаружившего, что уже имеющиеся данные ему это делать мешают. Правда, также мы представили, что он, возможно, хочет вводить свои объекты относительно имеющихся данных. Чтобы такое произошло, определённые данные уже должны быть добавлены на момент ввода новых объектов. В общем, можно утверждать, что данные вводятся согласно изменяющимся во времени предпочтениям осмеров, которые зависят от уже введённых данных, и для чего мы можем указать некоторые закономерности.

## Эволюция данных

В предыдущем разделе мы уже заметили, что мелкие объекты часто рисуются после и относительно крупных. По-другому это можно было бы сказать так: менее значимые объекты рисуются после и относительно более значимых. Это звучит уже менее определённо: мало ли, что для кого более значимо. Но и первый вариант неоднозначен. В этом подразделе мы назвали такие объекты, как здания и тротуары. Что больше - здание или тротуар? Если судить по длине, то обычно тротуар, если по площади, то может получиться по-разному. Вряд ли участник, рисующий тротуар, оценивает и с чем-то сравнивает его площадь. Так что мы не сможем в общем случае дать полностью однозначного ответа на вопрос, что было и будет нарисовано раньше, и что было и будет нарисовано относительно чего. С другой стороны и полностью неоднозначным этот ответ не является.

В итоге можно изобразить модель эволюции данных в определённом месте. Она получится в виде [ориентированного графа](https://ru.wikipedia.org/wiki/Ориентированный_граф), разные ветви которого соответствуют объектам с несравнимой значимостью. Несравнимая значимость для объектов типов А и Б - это когда одна группа участников утверждает, что важнее тип А, а другая - что тип Б. При этом обе группы достаточно активны, чтобы оказать заметное влияние на порядок ввода данных в местах своей активности. Ранее, в подразделе "мои данные важнее" мы уже рассматривали подобное утверждение, и тогда мы признали его неверным для правок отдельного участника в существенной степени на основе последовательности ввода данных большинством. По последовательности ввода большинством или существенной группой участников мы и можем судить об общепринятой значимости разных типов объектов.

Внимательные читатели, конечно, заметили в сказанном выше [круговую логику](https://ru.wikipedia.org/wiki/Круговое_рассуждение): вводится раньше то, что важнее, а важнее то, что вводится раньше. Действительно, анализ эволюции данных можно было бы провести аккуратнее, но для данной записи и так сойдёт. Если вас это сильно смущает, то забудьте, что в этом подразделе значимость упоминалась вообще. Можно считать, что мы просто видим последовательность ввода данных в интересующих нас условиях и ожидаем её повторения в подобных условиях, причины же всего этого нам неизвестны. Некоторые причины важности помимо последовательности, кстати, тоже указывались в предыдущем разделе.

Перед тем, как привести диаграмму, сделаем ещё несколько примечаний. Первое, что нужно отметить, это то, что пока она основана на моих впечатлениях без количественных оценок. Более точно её можно было бы получить, взяв репрезентативную выборку городов и проследив изменение данных для них. Позже я, возможно, это проделаю. Далее, раз уж была упомянута выборка городов, надо заметить, что рассматриваем мы только ситуацию в городе с достаточно чётко определёнными улицами и кварталами, а не в другом виде местности, например, в лесу. В лесу, кстати, тоже могут быть [кварталы](https://wiki.openstreetmap.org/wiki/RU:Tag:boundary%3Dforest_compartment), но у нас речь идёт не о них. Наконец, отметим, что указанная модель эволюции годится только для тех мест, объекты в которых существовали до начала осмерской активности. Если квартал мапится во время своего строительства, дела могут обстоять по-другому.

<p class="notice">
В данном месте должна быть диаграмма, про которую можно сказать примерно то же, что и про блок-схему из предыдущей главы: она, кажется, существует на листе бумаги, и этот лист надо найти.
</p>

{% TODO %}добавить в диаграмму про дробление landuse{% endTODO %}

## Наличие тротуаров

Поскольку нас интересует в первую очередь, включать ли тротуары в область сдвига, рассмотрим их. Как мы знаем, они могут быть не нарисованы. Такое бывает в следующих случаях:
* тротуара на самом деле нет;
* до рисования тротуара никто ещё не добрался;
* отдельную линию для тротуара посчитали излишней.

Глядя только на данные, не всегда можно понять, какой из вариантов имеет место. При доступных снимках, и, тем более, при разведке на местности, легко определить первый вариант. Для тех мест, которые рассматриваются в данной записи, он нетипичен, так как тротуары обычно есть со всех сторон вокруг кварталов. Далее мы будем считать, что тротуар в реальности существует. Два оставшихся варианта не обязательно противоречат друг другу, так как это могут быть мнения разных участников. Считающие, что линия тротуара не нужна, могут придерживаться своего мнения пассивно, то есть сами они линию рисовать не будут, но нарисованную кем-то другим линию удалять они удалять не будут. В реальности так, по-видимому, и есть, потому что активных удалений линий тротуаров не наблюдается.

Что же позволяет некоторым участникам считать, что линии тротуаров не нужны? Ответить на этот вопрос можно тоже с помощью эволюции данных. Данные в каждом месте имеют тенденцию к усложнению, но нелогично было бы сразу требовать сложных данных. Логично наоборот начинать с того, чтобы обозначать всё самым простым способом. Самый простой способ обозначить улицу целиком - проезжие части, тротуары, всё, что между и рядом с ними - провести одну линию, которой и является {% tag "highway=*" %}. Этот элемент мы и видим наверху нашей схемы эволюции. Если не указано иное, то эта линия является также и обозначением возможности пешеходного движения вдоль неё. Раз эта возможность обозначена, то становится меньше причин обозначать её ещё каким-то способом. Собственно, некоторые участники скажут, что здесь надо и остановиться, так как отдельные линии тротуаров лишние, они лишь загромождают данные, в линиях нет смысла, так как и так ясно, что у каждой улицы тротуары есть по обеим сторонам, тротуары не являются отдельными от улицы объектами и так далее.

Помимо логичной идеи о простоте данных, создание линий тротуаров тормозится идеей автомобилецентризма. Согласно этой идее, линии, вдоль которых разрешено движение, помимо рендеринга, задаются в первую очередь для построения маршрутов. Маршруты же нужны в первую очередь автомобилистам, а пешеходам они не так нужны или совсем не нужны. Автомобилисты едут далеко, оказываются в незнакомых местах и вообще торопятся. Пешеходы же ходят недалеко и по знакомым, часто каждый раз тем же самым местам, и никуда не торопятся, потому что если бы они торопились, то они бы воспользовались автомобилем, а если его нет, то общественным транспортом.

В некотором роде эта идея верна. На пешеходных скоростях действительно больше времени на принятие решения, куда перемещаться дальше. Следовательно, это решение можно принять и без помощи навигатора, пользуясь только изображением карты. Так обычно пешеходы и делают, если тротуары не нарисованы, подразумевая, что у улицы есть тротуары с обеих сторон, и что перекрёсток можно перейти в любом направлении. Это предположение обычно верно, но бывают и исключения, в первую очередь для переходов. У обычного перекрёстка может быть не четыре перехода, а три, у Т-образного - не три, а два, потому что какие-то направления переходов могут быть запрещены. Тогда будет лучше оказаться на правильной стороне улицы перед перекрёстком, иначе может оказаться нужным переходить улицу несколько лишних раз.

Чтобы оказываться на оптимальных сторонах улиц, нужно иметь данные о переходах. Однако, эти данные, если они в принципе есть, могут находиться в не вполне подходящем для пешеходов виде. Согласно идее автомобилецентризма, пешеходные переходы являются в первую очередь препятствием для автомобилистов. Отсюда берётся их более раннее обозначение точкой на линии улицы, без линии, соединяющей тротуары. Если мы этой идее следовать не собираемся, то переходы нам нужны с линиями, а тогда нам нужны и линии тротуаров, которые переходами соединяются. Если также принять, что существуют места без тротуаров, то становится ясно, что толк от линий тротуаров есть, и кто-нибудь до их рисования доберётся.

Если мы утверждаем, что отдельные линии тротуаров являются дальнейшим этапом эволюции данных, у нас есть соблазн посчитать, что там, где распространены мнения о ненужности этих линий, карта ещё не достигла существенного уровня детализации. Существенный уровень - это тот, который нас и интересует, так как именно при нём наши неосторожные действия по перемещению могут многое испортить. Однако можно посмотреть, например, на данные по Германии, и увидеть, что тротуары отдельными линиями там встречаются не слишком часто, а указывать на недоразвитость этих данных не слишком уместно. Известный аргумент против линий тротуаров в данном случае заключается в том, что неважно, где находится тротуар, если улицу можно без проблем перейти в любом месте. Этот же аргумент годится и для мест без интенсивного автомобильного движения. Получается, что противоположная автомобилецентризму крайность может также сыграть против отдельных линий. С точки зрения наших текущих задач о сдвиге мы не против подобных мнений, так как при них у нас будет меньше проблем. Другое дело, что сам сдвиг может быть обусловлен необходимостью добавления тротуаров, если мы с такими мнениями не согласны.

## Форма тротуаров

Участников, добравшихся таки до рисования тротуаров, иногда бывает не остановить. Они могут быть готовы рисовать тротуары и переходы даже там, где их нет. Данные, с которыми нам понадобится работать, могут быть результатом такого торопливого и неаккуратного рисования. Тут можно было бы указать много явлений, связанных с подобного рода редактированием, но, поскольку данная запись не про пешеходную навигацию, ограничимся здесь тем, что нужно для принятия решения о сдвиге.

Когда начинают рисовать тротуары там, где они совсем не нарисованы, часто делают это вдоль отдельной улицы. На протяжении нескольких кварталов, а то и всей длины улицы проводится линия {% tag "highway=footway" %}. Её пока не делят на собственно тротуары и переходы, так что на ней может не стоять тег {% tag "footway=*" %}. Поскольку в нашей ситуации квартал сдвинут, то высока вероятность, что и прочие кварталы, мимо которых идёт линия тротуара, сдвинуты. Сдвинуты они могут быть на различное расстояние, что должно вызвать затруднения у рисующего линию участника.

Сама улица, скорее всего, либо прямая целиком, либо имеет прямые участки длиной в несколько кварталов. Тротуар вдоль улицы обычно настолько же прямой, насколько и сама улица. Соответственно, его хочется провести прямой линией. Также хочется, чтобы эта линия проходила через площадь тротуара. Раз у нас всё сдвинуто, рисующему может быть неизвестно, где эта площадь находится. Она может быть видна на снимке, а может быть и не видна, причём не видна она может быть по всей стороне улицы из-за того, что снимок был сделан под углом. Следовательно, линия тротуара может оказаться нарисованной не на своём месте даже если улица и дома нарисованы на своём.

Сказанного выше уже достаточно для того, чтобы не слишком заботиться о сохранности положения такой линии тротуара. В нашем случае со сдвинутыми кварталами с её точностью дела могут обстоять ещё хуже. Если прямая линия тротуара проходит вдоль по-разному сдвинутых кварталов, она будет находиться на разных расстояниях от зданий. Если рассматривать площадь тротуара относительно зданий, может быть нереально провести эту прямую через площадь вдоль каждого квартала. Это выглядит как хорошая причина передвинуть кварталы ещё перед рисованием тротуара, но мы знаем, что наши предшественники на такое обычно не решаются. При таких обстоятельствах нам тем более не стоит заботиться о том, где именно проходит линия.

Если мы знаем, что после перемещения квартал не перекроет собой линию тротуара, у нас нет причин включать её в множество перемещаемых объектов. Если знаем, что перекроет, то их тоже нет. Точнее, мы не можем так просто передвинуть линию тротуара, потому что она длинная и проходит не только рядом с нашим кварталом. Что нам легче всего сделать - это проигнорировать её до выполнения сдвига, а потом с помощью инструмента выдавливания^ (x) сделать так, чтобы она обогнула квартал. Если мы хорошо представляем себе, куда мы сдвинем квартал, и не хотим, чтобы линия это место заслоняла и во время сдвига, можно выполнить выдавливание сразу. Выполняя выдавливание, мы, скорее всего, не портим идеально прямую форму тротуара, потому что он и не должен быть нарисован в виде одной прямой. Это связано со взаимным расположением тротуара и переходов, которое проявится при дальнейшем уточнении данных.

Перед тем, как рисовать тротуары отдельно от переходов, появляются такие же прямые линии тротуаров, пересекающие уже имеющиеся. Когда такие пересечения возникают на обеих сторонах улицы, появляются точки, между которыми линия тротуара должна преобразоваться в линию перехода. Линия тротуара в этих точках разрезается, чтобы поставить на её участок тег {% tag "footway=crossing" %}. Дальше сам переход может быть сдвинут на своё настоящее место, которое обычно находится дальше от перекрёстка, чем то место, по которому шла нераспиленная линия тротуара. Так участки тротуара вдоль отдельного квартала обретают независимость от участков вдоль других кварталов. Для нас это означает, что их уже можно двигать вместе с самим кварталом.

{% TODO %}серия скриншотов - эволюция линии тротуара{% endTODO %}

Стоит ли выбирать для сдвига участки тротуаров, не пересекающие улицы, которые проходят вокруг квартала, зависит от того, с чем эти участки лучше согласуются: с улицами или с кварталом. Изначально согласование было либо с улицами, либо ни с чем, но вместе с рисованием переходов линии тротуаров вокруг квартала могли быть подогнаны к самому кварталу. Если это произошло, их, конечно, стоит выбрать. При подгоне эти линии могли также соединить вместе в одну замкнутую линию вокруг квартала - в следующем подразделе написано, как это может нам пригодиться. Главное в этом случае заметить, что линия состоит не только из отрезка вдоль одной из сторон квартала, и согласиться с тем, что она будет целиком перемещена или целиком оставлена на месте.

Иногда мы модем обнаружить, что линия тротуара не огибает квартал и не идёт прямо вдоль улицы. Вместо этого она может идти как угодно: то по месту тротуара, то по месту перехода, сворачивая в точках пересечения {% tag "highway=footway" %} в произвольном направлении. Это является примером неаккуратного редактирования, когда участник дорисовывает недостающие проходы продолжением первой попавшейся ему линии, не пытаясь эту линию делить на осмысленные части. Проблемой такого редактирования является распространение тегов с ранее нарисованных проходов на новые, для которых эти теги уже неверны. Нас эта проблема в данный момент не волнует, обратить внимание нам надо только на то, что линия может уходить от нашего квартала в неожиданном направлении. В тех местах, где линия тротуара переходит на проезжую часть, её можно {% action "SplitWay" %}разрезать{% endaction %} (P). Можно также соединить её с другой линией тротуара, идущей вдоль нашего квартала, если у неё совместимые теги, хотя совместимость или несовместимость тегов может оказаться ошибочной ввиду их неправильного распространения.
